# Seata 分布式事务

## 分布式事务

### 本地事务

本地事务，也就是传统的单机事务。在传统数据库事务中，必须要满足四个原则：
![image-20210724165045186](assets/image-20210724165045186.png)

### 分布式事务

**分布式事务**，就是指不是在单个服务或单个数据库架构下，产生的事务，例如：

- 跨数据源的分布式事务
- 跨服务的分布式事务
- 综合情况

在数据库水平拆分、服务垂直拆分之后，一个业务操作通常要跨多个数据库、服务才能完成。例如电商行业中比较常见的下单付款案例，包括下面几个行为：

- 创建新订单
- 扣减商品库存
- 从用户账户余额扣除金额

完成上面的操作需要访问三个不同的微服务和三个不同的数据库。

![image-20210724165338958](assets/image-20210724165338958.png)

订单的创建、库存的扣减、账户扣款在每一个服务和数据库内是一个本地事务，可以保证ACID原则。

但是当我们把三件事情看做一个"业务"，要满足保证“业务”的原子性，要么所有操作全部成功，要么全部失败，不允许出现部分成功部分失败的现象，这就是**分布式系统下的事务**了。

此时ACID难以满足，这是分布式事务要解决的问题

## 理论基础

>解决分布式事务问题，需要一些分布式系统的基础知识作为理论指导。

### CAP定理

1998年，加州大学的计算机科学家 Eric Brewer 提出，分布式系统有三个指标。

> - Consistency（一致性）
> - Availability（可用性）
> - Partition tolerance （分区容错性）

![image-20210724170517944](assets/image-20210724170517944.png)

#### 一致性

Consistency（一致性）：用户访问分布式系统中的任意节点，得到的数据必须一致。

- 比如现在包含两个节点，其中的初始数据是一致的：
![image-20210724170704694](assets/image-20210724170704694.png)

- 当我们修改其中一个节点的数据时，两者的数据产生了差异：
![image-20210724170735847](assets/image-20210724170735847.png)

- 要想保住一致性，就必须实现node01 到 node02的数据 同步：
![image-20210724170834855](assets/image-20210724170834855.png)

#### 可用性

Availability （可用性）：用户访问集群中的任意健康节点，必须能得到响应，而不是超时或拒绝。

- 如图，有三个节点的集群，访问任何一个都可以及时得到响应：
![image-20210724170932072](assets/image-20210724170932072.png)

- 当有部分节点因为网络故障或其它原因无法访问时，代表节点不可用：
![image-20210724171007516](assets/image-20210724171007516.png)

#### 分区容错性

**Partition（分区）**：因为网络故障或其它原因导致分布式系统中的部分节点与其它节点失去连接，形成独立分区。

![image-20210724171041210](assets/image-20210724171041210.png)

**Tolerance（容错）**：在集群出现分区时，整个系统也要持续对外提供服务

#### 矛盾

在分布式系统中，系统间的网络不能100%保证健康，一定会有故障的时候，而服务有必须对外保证服务。因此Partition Tolerance不可避免。

当节点接收到新的数据变更时，就会出现问题了：

![image-20210724171546472](assets/image-20210724171546472.png)

如果此时要保证**一致性**，就必须等待网络恢复，完成数据同步后，整个集群才对外提供服务，服务处于阻塞状态，不可用。

如果此时要保证**可用性**，就不能等待网络恢复，那node01、node02与node03之间就会出现数据不一致。

>也就是说，在P一定会出现的情况下，A和C之间只能实现一个。

