# ðŸš€ MySQLäº‹åŠ¡å…¨é¢æŒ‡å—

## ðŸ“– ç¬¬ä¸€éƒ¨åˆ†ï¼šäº‹åŠ¡åŸºç¡€æ¦‚å¿µ

### 1.1 ä»€ä¹ˆæ˜¯äº‹åŠ¡ï¼ŸðŸ¤”

#### å­¦ä¹ ç›®æ ‡
- ç†è§£äº‹åŠ¡çš„åŸºæœ¬æ¦‚å¿µå’Œåº”ç”¨åœºæ™¯

#### æ ¸å¿ƒæ¦‚å¿µ
**äº‹åŠ¡**æŒ‡çš„æ˜¯é€»è¾‘ä¸Šçš„ä¸€ç»„æ“ä½œï¼Œç»„æˆè¿™ç»„æ“ä½œçš„å„ä¸ªå•å…ƒè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚

**äº‹åŠ¡ä½œç”¨**ï¼šä¿è¯åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­å¤šæ¬¡æ“ä½œæ•°æ®åº“è¡¨ä¸­æ•°æ®æ—¶ï¼Œè¦ä¹ˆå…¨éƒ½æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ½å¤±è´¥ã€‚

#### å®žé™…åº”ç”¨åœºæ™¯
ðŸ’¡ **ç”µå•†è½¬è´¦æ¡ˆä¾‹**ï¼š
- ä¹°å®¶ä»˜æ¬¾åŽï¼Œå¦‚æžœè½¬è´¦ç³»ç»Ÿå®•æœºï¼Œå–å®¶æœªæ”¶åˆ°é’±ä½†ä¹°å®¶å·²æ‰£æ¬¾ â†’ ä¸åˆç†
- ä¹°å®¶ä»˜æ¬¾åŽæ’¤é”€äº¤æ˜“ï¼Œä½†å–å®¶å·²å‘è´§ â†’ ä¸åˆç†

![](img\mysqläº‹åŠ¡1.bmp)

> **è¯´æ˜Ž**ï¼šåœ¨æ•°æ®åº“ä¸­æŸ¥è¯¢ä¸ä¼šæ¶‰åŠåˆ°ä½¿ç”¨äº‹åŠ¡ï¼Œéƒ½æ˜¯å¢žåˆ æ”¹æ“ä½œã€‚

#### ðŸ’¡ å°ç»“
äº‹åŠ¡æ˜¯**å¤šæ¡SQLç»„åˆåœ¨ä¸€èµ·å®ŒæˆæŸä¸ªåŠŸèƒ½**çš„æœºåˆ¶ã€‚

---

## âš™ï¸ ç¬¬äºŒéƒ¨åˆ†ï¼šäº‹åŠ¡æ“ä½œå®žè·µ

### 2.1 æ‰‹åŠ¨æäº¤äº‹åŠ¡ ðŸ› ï¸

#### å­¦ä¹ ç›®æ ‡
- æŽŒæ¡æ‰‹åŠ¨æäº¤äº‹åŠ¡çš„ä½¿ç”¨æ–¹æ³•

#### äº‹åŠ¡æ“ä½œæ–¹å¼
MySQLæ”¯æŒä¸¤ç§äº‹åŠ¡æ“ä½œæ–¹å¼ï¼š
- âœ… **æ‰‹åŠ¨æäº¤äº‹åŠ¡**ï¼šå…ˆå¼€å¯ï¼Œå†æäº¤
- ðŸ”„ **è‡ªåŠ¨æäº¤äº‹åŠ¡**ï¼ˆé»˜è®¤ï¼‰ï¼šæ‰§è¡Œä¸€æ¡SQLè¯­å¥æäº¤ä¸€æ¬¡äº‹åŠ¡

#### æ ¸å¿ƒSQLè¯­å¥
| SQLè¯­å¥ | æè¿° | è¡¨æƒ… |
|---------|------|------|
| `start transaction;` | å¼€å¯æ‰‹åŠ¨æŽ§åˆ¶äº‹åŠ¡ | ðŸšª |
| `commit;` | æäº¤äº‹åŠ¡ | âœ… |
| `rollback;` | å›žæ»šäº‹åŠ¡ | â†©ï¸ |

#### æ“ä½œæµç¨‹å›¾
![](img\äº‹åŠ¡01.png)

#### å‡†å¤‡æµ‹è¯•æ•°æ®
```sql
# åˆ›å»ºæµ‹è¯•æ•°æ®åº“å’Œè¡¨
create database day04_db; 
use day04_db;

create table account(
	id int primary key auto_increment,
	name varchar(20),
	money double
);

# åˆå§‹åŒ–æµ‹è¯•æ•°æ®
insert into account values (null,'a',1000);
insert into account values (null,'b',1000);
```

#### æ¡ˆä¾‹æ¼”ç¤º
**âœ… æˆåŠŸæäº¤äº‹åŠ¡**ï¼šaç»™bè½¬è´¦100å…ƒ
![](img\æäº¤äº‹åŠ¡.bmp)

**â†©ï¸ å›žæ»šäº‹åŠ¡**ï¼šaç»™bè½¬è´¦100å…ƒï¼ˆå¤±è´¥ï¼‰
![](img\å›žæ»šäº‹åŠ¡.bmp)

#### å…³é”®è¦ç‚¹
- æäº¤äº‹åŠ¡åŽï¼Œæ•°æ®æ°¸ä¹…ä¿å­˜ï¼Œæ— æ³•å›žæ»š
- å›žæ»šäº‹åŠ¡ä¼šæ’¤é”€æ‰€æœ‰å·²æ‰§è¡Œçš„SQLè¯­å¥
- æäº¤æˆ–å›žæ»šéƒ½ä»£è¡¨ç»“æŸå½“å‰äº‹åŠ¡

### 2.2 è‡ªåŠ¨æäº¤äº‹åŠ¡ âš¡

#### å­¦ä¹ ç›®æ ‡
- äº†è§£è‡ªåŠ¨æäº¤äº‹åŠ¡æœºåˆ¶
- æŽŒæ¡å…³é—­è‡ªåŠ¨æäº¤çš„æ–¹æ³•

#### è‡ªåŠ¨æäº¤æœºåˆ¶
MySQLé»˜è®¤æ¯æ¡DMLè¯­å¥éƒ½æ˜¯ä¸€ä¸ªå•ç‹¬çš„äº‹åŠ¡ï¼Œæ‰§è¡Œå®Œæ¯•è‡ªåŠ¨æäº¤ã€‚

#### æŸ¥çœ‹å’Œè®¾ç½®è‡ªåŠ¨æäº¤
```sql
# æŸ¥çœ‹å½“å‰autocommitæ¨¡å¼
show variables like '%commit%';
```
![](img\è‡ªåŠ¨æäº¤äº‹åŠ¡.bmp)

```sql
# å…³é—­è‡ªåŠ¨æäº¤ï¼ˆä¸´æ—¶ç”Ÿæ•ˆï¼‰
set autocommit = 0;  -- 0:å…³é—­  1:å¼€å¯
```

#### å®žè·µä»£ç ç¤ºä¾‹
```sql
-- è‡ªåŠ¨æäº¤äº‹åŠ¡æ¼”ç¤º
update account set money=money-100 where name='a';
update account set money=money+100 where name='b';

-- æŸ¥çœ‹å’Œè®¾ç½®è‡ªåŠ¨æäº¤
show variables like '%commit%';
set autocommit = 0;
```

#### ðŸ’¡ é‡è¦è¯´æ˜Ž
1. MySQL**é»˜è®¤è‡ªåŠ¨æäº¤**ï¼Œæ‰§è¡Œä¸€æ¡SQLæäº¤ä¸€æ¬¡äº‹åŠ¡
2. `set autocommit = 0`åªæ˜¯**ä¸´æ—¶è®¾ç½®**ï¼Œé‡æ–°è¿žæŽ¥åŽæ¢å¤é»˜è®¤
3. æ‰‹åŠ¨å¼€å¯äº‹åŠ¡(`start transaction;`)ä¼š**è¦†ç›–è‡ªåŠ¨æäº¤è®¾ç½®**
4. ä¸æ‰‹åŠ¨å¼€å¯äº‹åŠ¡æ—¶ï¼Œæ¯æ¡SQLéƒ½æ˜¯ç‹¬ç«‹äº‹åŠ¡

---

## ðŸ” ç¬¬ä¸‰éƒ¨åˆ†ï¼šäº‹åŠ¡åŽŸç†ä¸Žç‰¹æ€§

### 3.1 äº‹åŠ¡å·¥ä½œåŽŸç† ðŸ”§

![](img\äº‹åŠ¡19.png)

#### åŽŸç†è¯´æ˜Ž
1. **ä¸´æ—¶æ—¥å¿—æ–‡ä»¶**ï¼šç”¨æˆ·ç™»å½•åŽåˆ›å»ºï¼Œä¿å­˜äº‹åŠ¡çŠ¶æ€
2. **æ— äº‹åŠ¡æ“ä½œ**ï¼šç›´æŽ¥å†™å…¥æ•°æ®åº“ï¼Œä¸ä½¿ç”¨æ—¥å¿—æ–‡ä»¶
3. **å¼€å¯äº‹åŠ¡**ï¼šæ‰€æœ‰å†™æ“ä½œå†™å…¥æ—¥å¿—æ–‡ä»¶
4. **æäº¤äº‹åŠ¡**ï¼šæ—¥å¿—æ–‡ä»¶å†…å®¹å†™å…¥æ•°æ®åº“
5. **å›žæ»šäº‹åŠ¡**ï¼šæ¸…ç©ºæ—¥å¿—æ–‡ä»¶ï¼Œä¸å½±å“æ•°æ®åº“

#### äº‹åŠ¡æ“ä½œæ€»ç»“è¡¨
| æ“ä½œ | MySQLè¯­å¥ | è¯´æ˜Ž |
|------|-----------|------|
| æ‰‹åŠ¨å¼€å¯äº‹åŠ¡ | `start transaction` | ðŸšª å¼€å¯äº‹åŠ¡ |
| æ‰‹åŠ¨æäº¤äº‹åŠ¡ | `commit` | âœ… æ°¸ä¹…ä¿å­˜ |
| æ‰‹åŠ¨å›žæ»šäº‹åŠ¡ | `rollback` | â†©ï¸ æ’¤é”€æ“ä½œ |
| æŸ¥è¯¢è‡ªåŠ¨æäº¤ | `show variables like '%commit%'` | ðŸ” æŸ¥çœ‹çŠ¶æ€ |
| è®¾ç½®æ‰‹åŠ¨æäº¤ | `set autocommit = 0` | âš™ï¸ å…³é—­è‡ªåŠ¨æäº¤ |

### 3.2 äº‹åŠ¡çš„å››å¤§ç‰¹æ€§(ACID) ðŸŽ¯

#### å­¦ä¹ ç›®æ ‡
- æŽŒæ¡äº‹åŠ¡çš„ACIDç‰¹æ€§

#### å››å¤§ç‰¹æ€§è¯¦è§£

**ðŸ”’ éš”ç¦»æ€§ (Isolation)**
- å¤šä¸ªå¹¶å‘äº‹åŠ¡ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼Œäº’ä¸å¹²æ‰°
- ä¾‹ï¼šaè½¬è´¦ç»™b å’Œ cè½¬è´¦ç»™d ä¸¤ä¸ªäº‹åŠ¡äº’ä¸å½±å“

**ðŸ’¾ æŒä¹…æ€§ (Durability)**
- äº‹åŠ¡æäº¤åŽï¼Œå¯¹æ•°æ®åº“çš„æ”¹å˜æ˜¯æ°¸ä¹…æ€§çš„
- å³ä½¿æ•°æ®åº“å¼‚å¸¸é‡å¯ï¼Œæ•°æ®ä¾ç„¶ä¿æŒä¸å˜

**âš›ï¸ åŽŸå­æ€§ (Atomicity)**
- äº‹åŠ¡ä¸­çš„æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥
- ä¸å¯åˆ†å‰²çš„å·¥ä½œå•ä½

**ðŸ”„ ä¸€è‡´æ€§ (Consistency)**
- äº‹åŠ¡æ‰§è¡Œå‰åŽï¼Œæ•°æ®åº“å¿…é¡»å¤„äºŽä¸€è‡´æ€§çŠ¶æ€
- æˆåŠŸï¼šæ‰€æœ‰å˜åŒ–ç”Ÿæ•ˆï¼›å¤±è´¥ï¼šå›žæ»šåˆ°åŽŸå§‹çŠ¶æ€

#### ACIDç‰¹æ€§æ€»ç»“è¡¨
| ç‰¹æ€§ | å«ä¹‰ | é‡è¦æ€§ |
|------|------|--------|
| ä¸€è‡´æ€§ | äº‹åŠ¡å‰åŽæ•°æ®å®Œæ•´æ€§ä¿æŒä¸€è‡´ | ðŸŒŸðŸŒŸðŸŒŸðŸŒŸðŸŒŸ |
| åŽŸå­æ€§ | äº‹åŠ¡æ“ä½œè¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥ | ðŸŒŸðŸŒŸðŸŒŸðŸŒŸðŸŒŸ |
| éš”ç¦»æ€§ | å¹¶å‘äº‹åŠ¡ä¹‹é—´ç›¸äº’éš”ç¦» | ðŸŒŸðŸŒŸðŸŒŸðŸŒŸ |
| æŒä¹…æ€§ | äº‹åŠ¡æäº¤åŽæ”¹å˜æ°¸ä¹…ä¿å­˜ | ðŸŒŸðŸŒŸðŸŒŸðŸŒŸ |

---

## âš ï¸ ç¬¬å››éƒ¨åˆ†ï¼šäº‹åŠ¡å¹¶å‘é—®é¢˜

### 4.1 å¹¶å‘è®¿é—®çš„ä¸‰å¤§é—®é¢˜ ðŸš¨

#### å­¦ä¹ ç›®æ ‡
- ç†è§£äº‹åŠ¡å¹¶å‘è®¿é—®å¯èƒ½å¼•å‘çš„é—®é¢˜

#### é—®é¢˜åˆ†ç±»ä¸Žè¯´æ˜Ž

**ðŸ’€ è„è¯» (Dirty Read)**
- **å®šä¹‰**ï¼šä¸€ä¸ªäº‹åŠ¡è¯»å–äº†å¦ä¸€ä¸ªäº‹åŠ¡**æœªæäº¤çš„æ•°æ®**
- **ä¸¥é‡ç¨‹åº¦**ï¼šâ­ï¸â­ï¸â­ï¸â­ï¸â­ï¸ï¼ˆå¿…é¡»é¿å…ï¼‰
- **ç¤ºæ„å›¾**ï¼š![](img\è„è¯».bmp)

**ðŸ”„ ä¸å¯é‡å¤è¯» (Non-repeatable Read)**
- **å®šä¹‰**ï¼šåŒä¸€äº‹åŠ¡å†…å¤šæ¬¡è¯»å–çš„**æ•°æ®å†…å®¹ä¸ä¸€è‡´**
- **åŽŸå› **ï¼šå¦ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œäº†**UPDATE**æ“ä½œ
- **ç¤ºæ„å›¾**ï¼š![](img\ä¸å¯é‡å¤è¯».bmp)

**ðŸ‘» å¹»è¯» (Phantom Read)**
- **å®šä¹‰**ï¼šåŒä¸€äº‹åŠ¡å†…å¤šæ¬¡è¯»å–çš„**æ•°æ®æ•°é‡ä¸ä¸€è‡´**
- **åŽŸå› **ï¼šå¦ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œäº†**INSERTæˆ–DELETE**æ“ä½œ
- **ç¤ºæ„å›¾**ï¼š![](img\å¹»è¯».bmp)

#### é—®é¢˜å¯¹æ¯”è¡¨
| é—®é¢˜ç±»åž‹ | è¯»å–å†…å®¹ | å…¶ä»–äº‹åŠ¡æ“ä½œ | ä¸¥é‡ç¨‹åº¦ |
|----------|----------|--------------|----------|
| è„è¯» | æœªæäº¤æ•°æ® | ä»»ä½•ä¿®æ”¹ | â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸ |
| ä¸å¯é‡å¤è¯» | å·²æäº¤æ•°æ® | UPDATE | â­ï¸â­ï¸â­ï¸ |
| å¹»è¯» | å·²æäº¤æ•°æ® | INSERT/DELETE | â­ï¸â­ï¸â­ï¸ |

---

## ðŸ›¡ï¸ ç¬¬äº”éƒ¨åˆ†ï¼šäº‹åŠ¡éš”ç¦»çº§åˆ«

### 5.1 MySQLéš”ç¦»çº§åˆ«è¯¦è§£ ðŸŽšï¸

#### å­¦ä¹ ç›®æ ‡
- æŽŒæ¡MySQLçš„å››ç§éš”ç¦»çº§åˆ«åŠå…¶åº”ç”¨

#### éš”ç¦»çº§åˆ«å¯¹æ¯”è¡¨
| çº§åˆ« | åç§° | éš”ç¦»çº§åˆ« | è„è¯» | ä¸å¯é‡å¤è¯» | å¹»è¯» | é»˜è®¤ä½¿ç”¨ |
|------|------|----------|------|------------|------|----------|
| 1 | è¯»æœªæäº¤ | read uncommitted | âœ… | âœ… | âœ… | - |
| 2 | è¯»å·²æäº¤ | read committed | âŒ | âœ… | âœ… | Oracle/SQL Server |
| 3 | å¯é‡å¤è¯» | repeatable read | âŒ | âŒ | âœ… | **MySQL** |
| 4 | ä¸²è¡ŒåŒ– | serializable | âŒ | âŒ | âŒ | - |

#### å®‰å…¨æ€§ä¸Žæ€§èƒ½æƒè¡¡
- **å®‰å…¨æ€§**ï¼šserializable > repeatable read > read committed > read uncommitted
- **æ€§èƒ½**ï¼šserializable < repeatable read < read committed < read uncommitted

#### ðŸ’¡ å®žé™…åº”ç”¨å»ºè®®
- **è„è¯»**ï¼šå¿…é¡»é¿å…ï¼Œé€»è¾‘é”™è¯¯
- **ä¸å¯é‡å¤è¯»/å¹»è¯»**ï¼šæ—¶æ•ˆæ€§é—®é¢˜ï¼Œå¯æŽ¥å—ï¼ˆæ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼‰

### 5.2 éš”ç¦»çº§åˆ«è®¾ç½®ä¸Žå®žè·µ ðŸ”§

#### æŸ¥è¯¢å½“å‰éš”ç¦»çº§åˆ«
```sql
-- æ–¹æ³•ä¸€ï¼šæŸ¥çœ‹å…¨å±€äº‹åŠ¡éš”ç¦»çº§åˆ«
show variables like '%isolation%';

-- æ–¹æ³•äºŒï¼šæŸ¥è¯¢å½“å‰éš”ç¦»çº§åˆ«
select @@tx_isolation;
```

#### è®¾ç½®éš”ç¦»çº§åˆ«
```sql
-- è®¾ç½®å…¨å±€éš”ç¦»çº§åˆ«ï¼ˆéœ€è¦é‡æ–°è¿žæŽ¥ç”Ÿæ•ˆï¼‰
set global transaction isolation level éš”ç¦»çº§åˆ«;

-- ç¤ºä¾‹ï¼š
set global transaction isolation level read uncommitted;
set global transaction isolation level repeatable read;
```

#### ðŸš¨ æ³¨æ„äº‹é¡¹
MySQL 5.6+ç‰ˆæœ¬è®¾ç½®`read uncommitted`å¯èƒ½æŠ¥é”™ï¼Œéœ€è¦é¢å¤–è®¾ç½®ï¼š
```sql
# è®¾ç½®sessionçº§åˆ«çš„BINLOGæ ¼å¼
SET SESSION binlog_format = 'MIXED';

# æŸ¥çœ‹å½“å‰BINLOGæ ¼å¼
select @@binlog_format;
```

---

## ðŸŽ¯ ç»¼åˆæ€»ç»“

### ðŸ“Š æ ¸å¿ƒçŸ¥è¯†ç‚¹å›žé¡¾
1. **äº‹åŠ¡æœ¬è´¨**ï¼šä¿è¯æ•°æ®æ“ä½œçš„åŽŸå­æ€§å’Œä¸€è‡´æ€§
2. **æ“ä½œæ–¹å¼**ï¼šæ‰‹åŠ¨æäº¤ vs è‡ªåŠ¨æäº¤
3. **ACIDç‰¹æ€§**ï¼šåŽŸå­æ€§ã€ä¸€è‡´æ€§ã€éš”ç¦»æ€§ã€æŒä¹…æ€§
4. **å¹¶å‘é—®é¢˜**ï¼šè„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»
5. **éš”ç¦»çº§åˆ«**ï¼šå››ç§çº§åˆ«ï¼ŒMySQLé»˜è®¤ä½¿ç”¨å¯é‡å¤è¯»

### ðŸ’ª æœ€ä½³å®žè·µå»ºè®®
- âœ… é‡è¦ä¸šåŠ¡æ“ä½œä½¿ç”¨**æ‰‹åŠ¨äº‹åŠ¡æŽ§åˆ¶**
- âœ… æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©åˆé€‚çš„**éš”ç¦»çº§åˆ«**
- âœ… é¿å…**è„è¯»**ï¼Œåˆç†å¤„ç†ä¸å¯é‡å¤è¯»å’Œå¹»è¯»
- âœ… ç†è§£äº‹åŠ¡åŽŸç†ï¼Œä¼˜åŒ–æ•°æ®åº“æ€§èƒ½

### ðŸ”® æ‰©å±•å­¦ä¹ æ–¹å‘
- åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†
- äº‹åŠ¡çš„é”æœºåˆ¶
- æ•°æ®åº“è¿žæŽ¥æ± ä¸Žäº‹åŠ¡ç®¡ç†
- äº‹åŠ¡åœ¨å¾®æœåŠ¡æž¶æž„ä¸­çš„åº”ç”¨