# 📚 MongoDB 高级

## 🔄 副本集-Replica Sets

- MongoDB中的副本集（Replica Set）是一组维护相同数据集的mongod服务。 副本集可提供冗余和高可用性，是所有生产部署的基础。
- 也可以说，副本集类似于有自动故障恢复功能的主从集群。通俗的讲就是用多台机器进行同一数据的异步同步，从而使多台机器拥有同一数据的多个副本，并且当主库当掉时在不需要用户干预的情况下自动切换其他备份服务器做主库。而且还可以利用副本服务器做只读服务器，实现读写分离，提高负载。

### 1️⃣ 冗余和数据可用性

- 复制提供冗余并提高数据可用性。 通过在不同数据库服务器上提供多个数据副本，复制可提供一定级别的容错功能，以防止丢失单个数据库服务器。
- 在某些情况下，复制可以提供增加的读取性能，因为客户端可以将读取操作发送到不同的服务上， 在不同数据中心维护数据副本可以增加分布式应用程序的数据位置和可用性。 您还可以为专用目的维护其他副本，例如灾难恢复，报告或备份。

### 2️⃣ MongoDB中的复制

- 副本集是一组维护相同数据集的mongod实例。 副本集包含多个数据承载节点和可选的一个仲裁节点。在承载数据的节点中，一个且仅一个成员被视为主节点，而其他节点被视为次要（从）节点。
- 主节点接收所有写操作。 副本集只能有一个主要能够确认具有{w："most"}写入关注的写入; 虽然在某些情况下，另一个mongod实例可能暂时认为自己也是主要的。主要记录其操作日志中的数据集的所有更改，即oplog。

![img_6.png](imgs/img_6.png)

- 辅助(副本)节点复制主节点的oplog并将操作应用于其数据集，以使辅助节点的数据集反映主节点的数据集。 如果主要人员不在，则符合条件的中学将举行选举以选出新的主要人员。

### 3️⃣ 主从复制和副本集区别

- 主从集群和副本集最大的区别就是副本集没有固定的"主节点"；整个集群会选出一个"主节点"，当其挂掉后，又在剩下的从节点中选中其他节点为"主节点"，副本集总有一个活跃点(主、primary)和一个或多个备份节点(从、secondary)。

### 4️⃣ 副本集的两种类型和三种角色

- 两种类型：
    - 主节点（Primary）类型：数据操作的主要连接点，可读写。
    - 次要（辅助、从）节点（Secondaries）类型：数据冗余备份节点，可以读或选举。

- 三种角色：

    - 主要成员（Primary）：主要接收所有写操作。就是主节点。
    - 副本成员（Replicate）：从主节点通过复制操作以维护相同的数据集，即备份数据，不可写操作，但可以读操作（但需要配置）。是默认的一种从节点类型。
    - 仲裁者（Arbiter）：不保留任何数据的副本，只具有投票选举作用。当然也可以将仲裁服务器维护为副本集的一部分，即副本成员同时也可以是仲裁者。也是一种从节点类型。

![img_7.png](imgs/img_7.png)

> 💡 **小贴士**：您可以将额外的mongod实例添加到副本集作为仲裁者。 仲裁者不维护数据集。 仲裁者的目的是通过响应其他副本集成员的心跳和选举请求来维护副本集中的仲裁。 因为它们不存储数据集，所以仲裁器可以是提供副本集仲裁功能的好方法，其资源成本比具有数据集的全功能副本集成员更便宜。        
> 1.如果您的副本集具有偶数个成员，请添加仲裁者以获得主要选举中的"大多数"投票。 仲裁者不需要专用硬件。            
> 2.仲裁者将永远是仲裁者，而主要人员可能会退出并成为次要人员，而次要人员可能成为选举期间的主要人员。          
> 3.如果你的副本+主节点的个数是偶数，建议加一个仲裁者，形成奇数，容易满足大多数的投票。            
> 4.如果你的副本+主节点的个数是奇数，可以不加仲裁者。

### 5️⃣ 副本集的架构

- 一主一副本一仲裁

![img_8.png](imgs/img_8.png)

### 6️⃣ 主节点的选举原则

- MongoDB在副本集中，会自动进行主节点的选举，主节点选举的触发条件
    - 主节点故障
    - 主节点网络不可达（默认心跳信息为10秒）
    - 人工干预（rs.stepDown(600)）

- 选举规则是根据票数来决定谁获胜：
- 票数最高，且获得了"大多数"成员的投票支持的节点获胜。
    - "大多数"的定义为：假设复制集内投票成员数量为N，则大多数为 N/2 + 1。例如：3个投票成员，则大多数的值是2。当复制集内存活成员数量不足大多数时，整个复制集将无法选举出Primary，复制集将无法提供写服务，处于只读状态。
- 若票数相同，且都获得了"大多数"成员的投票支持的，数据新的节点获胜。
    - 数据的新旧是通过操作日志oplog来对比的。

- 在获得票数的时候，优先级（priority）参数影响重大。
    - 可以通过设置优先级（priority）来设置额外票数。优先级即权重，取值为0-1000，相当于可额外增加0-1000的票数，优先级的值越大，就越可能获得多数成员的投票（votes）数。指定较高的值可使成员更有资格成为主要成员，更低的值可使成员更不符合条件。
- 默认情况下，优先级的值是1

#### 修改优先级

- 先将配置导入cfg变量

```shell
myrs:SECONDARY> cfg=rs.conf()
```


- 然后修改值（ID号默认从0开始）

```shell
myrs:SECONDARY> cfg.members[1].priority=2
```


- 重新加载配置

```shell
myrs:SECONDARY> rs.reconfig(cfg)
```


### 7️⃣ SpringDataMongoDB 连接副本集

- 副本集语法

```text
mongodb://host1,host2,host3/articledb?connect=replicaSet&slaveOk=true&replicaSet=副本集名字
```


- slaveOk=true：开启副本节点读的功能，可实现读写分离
- connect=replicaSet：自动到副本集中选择读写的主机。如果slaveOK是打开的，则实现了读写分离

```yaml
spring:
  data:
    mongodb:
      uri: mongodb://180.76.159.126:27017,180.76.159.126:27018,180.76.159.126:27019/articledb?connect=replicaSet&slaveOk=true&replicaSet=myrs
```


> 📌 **注意**：主机必须是副本集中所有的主机，包括主节点、副本节点、仲裁节点。

- `mongodb://` : 这是固定的格式，必须要指定。
- `username:password@` : 可选项，如果设置，在连接数据库服务器之后，驱动都会尝试登陆这个数据库
- `host1` : 必须的指定至少一个host, host1 是这个URI唯一要填写的。它指定了要连接服务器的地址。如果要连接复制集，请指定多个主机地址。
- `portX` : 可选的指定端口，如果不填，默认为27017
- `/database` : 如果指定username:password@，连接并验证登陆指定数据库。若不指定，默认打开 test 数据库。
- `?options` : 是连接选项。如果不使用/database，则前面需要加上/。所有连接选项都是键值对 name=value，键值对之间通过&或;（分号）隔开

![img_9.png](imgs/img_9.png)

## 🗂️ 分片集群-Sharded Cluster

### 分片概念

- 分片（sharding）是一种跨多台机器分布数据的方法， MongoDB使用分片来支持具有非常大的数据集和高吞吐量操作的部署。
- 换句话说：分片(sharding)是指将数据拆分，将其分散存在不同的机器上的过程。有时也用分(partitioning)来表示这个概念。将数据分散到不同的机器上，不需要功能强大的大型计算机就可以储存更多的数据，处理更多的负载。
- 具有大型数据集或高吞吐量应用程序的数据库系统可以会挑战单个服务器的容量。例如，高查询率会耗尽服务器的CPU容量。工作集大小大于系统的RAM会强调磁盘驱动器的I / O容量。
- 有两种解决系统增长的方法：垂直扩展和水平扩展。
    - **垂直扩展**意味着增加单个服务器的容量，例如使用更强大的CPU，添加更多RAM或增加存储空间量。可用技术的局限性可能会限制单个机器对于给定工作负载而言足够强大。此外，基于云的提供商基于可用的硬件配置具有硬性上限。结果，垂直缩放有实际的最大值。
    - **水平扩展**意味着划分系统数据集并加载多个服务器，添加其他服务器以根据需要增加容量。虽然单个机器的总体速度或容量可能不高，但每台机器处理整个工作负载的子集，可能提供比单个高速大容量服务器更高的效率。扩展部署容量只需要根据需要添加额外的服务器，这可能比单个机器的高端硬件的总体成本更低。权衡是基础架构和部署维护的复杂性增加。
- MongoDB支持通过分片进行水平扩展。

### 分片集群包含的组件

- MongoDB分片群集包含以下组件：
    - **分片**（存储）：每个分片包含分片数据的子集。
    - **mongos**（路由）：mongos充当查询路由器，在客户端应用程序和分片集群之间提供接口。每个分片都可以部署为副本集。
    - **config servers**（"调度"的配置）：配置服务器存储群集的元数据和配置设置。 从MongoDB 3.4开始，必须将配置服务器部署为副本集（CSRS）。

![img_10.png](imgs/img_10.png)

### 分片集群架构目标

- 两个分片节点副本集（3+3）+一个配置节点副本集（3）+两个路由节点（2），共11个服务节点。

![img_11.png](imgs/img_11.png)

### SpringDataMongDB 连接分片集群

```yaml
spring:
  data:
    mongodb:
      uri: mongodb://180.76.159.126:27017,180.76.159.126:27117/articledb
```


## 🔐 安全认证

### MongoDB 的用户和角色权限

- 默认情况下，MongoDB实例启动运行时是没有启用用户访问权限控制的，也就是说，在实例本机服务器上都可以随意连接到实例进行各种操作，MongoDB不会对连接客户端进行用户验证，这是非常危险的。
- mongodb官网上说，为了能保障mongodb的安全可以做以下几个步骤：
    - 使用新的端口，默认的27017端口如果一旦知道了ip就能连接上，不太安全。
    - 设置mongodb的网络环境，最好将mongodb部署到公司服务器内网，这样外网是访问不到的。公司内部访问使用vpn等。
    - 开启安全认证。认证要同时设置服务器之间的内部认证方式，同时要设置客户端连接到集群的账号密码认证方式。

为了强制开启用户访问控制(用户验证)，则需要在MongoDB实例启动时使用选项 --auth 或在指定启动配置文件中添加选项 auth=true

- 启用访问控制：
    - MongoDB使用的是基于角色的访问控制(Role-Based Access Control,RBAC)来管理用户对实例的访问。通过对用户授予一个或多个角色来控制用户访问数据库资源的权限和数据库操作的权限，在对用户分配角色之前，用户无法访问实例。
    - 在实例启动时添加选项 --auth 或指定启动配置文件中添加选项 auth=true

- 角色：
    - 在MongoDB中通过角色对用户授予相应数据库资源的操作权限，每个角色当中的权限可以显式指定，也可以通过继承其他角色的权限，或者两都都存在的权限。

- 权限：
    - 权限由指定的数据库资源(resource)以及允许在指定资源上进行的操作(action)组成。
        1. 资源(resource)包括：数据库、集合、部分集合和集群；
        2. 操作(action)包括：对资源进行的增、删、改、查(CRUD)操作。

- 在角色定义时可以包含一个或多个已存在的角色，新创建的角色会继承包含的角色所有的权限。在同一个数据库中，新创建角色可以继承其他角色的权限，在 admin 数据库中创建的角色可以继承在其它任意数据库中角色的权限。

#### 查询所有角色权限(仅用户自定义角色)

```shell
db.runCommand({ rolesInfo: 1 })
```


#### 查询所有角色权限(包含内置角色)

```shell
db.runCommand({ rolesInfo: 1, showBuiltinRoles: true })
```


#### 查询当前数据库中的某角色的权限

```shell
db.runCommand({ rolesInfo: "<rolename>" })
```


#### 查询其它数据库中指定的角色权限

```shell
db.runCommand({ rolesInfo: { role: "<rolename>", db: "<database>" } }
```


#### 查询多个角色权限

```shell
db.runCommand(
    {
        rolesInfo: [
            "<rolename>",
            { role: "<rolename>", db: "<database>" },
            ...
        ]     
    }
)
```


- 常用的内置角色：
    - **数据库用户角色**：read、readWrite
    - **所有数据库用户角色**：readAnyDatabase、readWriteAnyDatabase、userAdminAnyDatabase、dbAdminAnyDatabase
    - **数据库管理角色**：dbAdmin、dbOwner、userAdmin
    - **集群管理角色**：clusterAdmin、clusterManager、clusterMonitor、hostManager
    - **备份恢复角色**：backup、restore
    - **超级用户角色**：root
    - **内部角色**：system

![img_12.png](imgs/img_12.png)

### 🖥️ 单实例环境

> 对单实例的MongoDB服务开启安全认证，这里的单实例指的是未开启副本集或分片的MongoDB实例

#### 添加用户和权限

- 使用库

```shell
use admin
```


- 创建系统超级用户并授权

```shell
db.createUser({user:"root",pwd:"123456",roles:["root"]})
```


- 创建普通用户并授权

```shell
db.createUser({user:"myadmin",pwd:"123456",roles:[{role:"userAdminAnyDatabase",db:"admin"}]})
```


- 查看已经创建了的用户的情况

```shell
db.system.users.find()
```


- 删除用户

```shell
db.dropUser("myadmin")
```


- 修改密码

```shell
db.changeUserPassword("myroot", "123456")
```


- 本案例创建了两个用户，分别对应超管和专门用来管理用户的角色，事实上，你只需要一个用户即可。如果你对安全要求很高，防止超管泄漏，则不要创建超管用户。
- 和其它数据库（MySQL）一样，权限的管理都差不多一样，也是将用户和权限信息保存到数据库对应的表中。Mongodb存储所有的用户信息在admin 数据库的集合system.users中，保存用户名、密码和数据库信息。
- 如果不指定数据库，则创建的指定的权限的用户在所有的数据库上有效，如 {role:"userAdminAnyDatabase", db:""}

#### SpringDataMongoDB 连接认证

- 使用用户名和密码连接到 MongoDB 服务器，你必须使用 'username:password@hostname/dbname' 格式，'username' 为用户名，'password' 为密码

```yaml
spring:
  data:
    mongodb:
      uri: mongodb://[username]:[password]@180.76.159.126:27017/articledb
```


### 🔄 副本集环境

- 只需要在主节点上添加用户，副本集会自动同步。

#### SpringDataMongoDB 连接副本集

```yaml
spring:
  data:
    mongodb:
      uri: mongodb://[username]:[password]@180.76.159.126:27017,180.76.159.126:27018,180.76.159.126:27019/articledb?connect=replicaSet&slaveOk=true&replicaSet=myrs
```
