# MongoDB ğŸ“Š

## æ¦‚å¿µ ğŸ¤”

### åº”ç”¨åœºæ™¯ ğŸ¯

- ç¤¾äº¤åœºæ™¯ï¼Œä½¿ç”¨ MongoDB å­˜å‚¨å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ï¼Œä»¥åŠç”¨æˆ·å‘è¡¨çš„æœ‹å‹åœˆä¿¡æ¯ï¼Œé€šè¿‡åœ°ç†ä½ç½®ç´¢å¼•å®ç°é™„è¿‘çš„äººã€åœ°ç‚¹ç­‰åŠŸèƒ½ã€‚
- æ¸¸æˆåœºæ™¯ï¼Œä½¿ç”¨ MongoDB å­˜å‚¨æ¸¸æˆç”¨æˆ·ä¿¡æ¯ï¼Œç”¨æˆ·çš„è£…å¤‡ã€ç§¯åˆ†ç­‰ç›´æ¥ä»¥å†…åµŒæ–‡æ¡£çš„å½¢å¼å­˜å‚¨ï¼Œæ–¹ä¾¿æŸ¥è¯¢ã€é«˜æ•ˆç‡å­˜å‚¨å’Œè®¿é—®ã€‚
- ç‰©æµåœºæ™¯ï¼Œä½¿ç”¨ MongoDB å­˜å‚¨è®¢å•ä¿¡æ¯ï¼Œè®¢å•çŠ¶æ€åœ¨è¿é€è¿‡ç¨‹ä¸­ä¼šä¸æ–­æ›´æ–°ï¼Œä»¥ MongoDB å†…åµŒæ•°ç»„çš„å½¢å¼æ¥å­˜å‚¨ï¼Œä¸€æ¬¡æŸ¥è¯¢å°±èƒ½å°†è®¢å•æ‰€æœ‰çš„å˜æ›´è¯»å–å‡ºæ¥ã€‚
- ç‰©è”ç½‘åœºæ™¯ï¼Œä½¿ç”¨ MongoDB å­˜å‚¨æ‰€æœ‰æ¥å…¥çš„æ™ºèƒ½è®¾å¤‡ä¿¡æ¯ï¼Œä»¥åŠè®¾å¤‡æ±‡æŠ¥çš„æ—¥å¿—ä¿¡æ¯ï¼Œå¹¶å¯¹è¿™äº›ä¿¡æ¯è¿›è¡Œå¤šç»´åº¦çš„åˆ†æã€‚
- è§†é¢‘ç›´æ’­ï¼Œä½¿ç”¨ MongoDB å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ã€ç‚¹èµäº’åŠ¨ä¿¡æ¯ç­‰ã€‚

è¿™äº›åº”ç”¨åœºæ™¯ä¸­ï¼Œæ•°æ®æ“ä½œæ–¹é¢çš„å…±åŒç‰¹ç‚¹æ˜¯ï¼š
+ æ•°æ®é‡å¤§
+ å†™å…¥æ“ä½œé¢‘ç¹ï¼ˆè¯»å†™éƒ½å¾ˆé¢‘ç¹ï¼‰
+ ä»·å€¼è¾ƒä½çš„æ•°æ®ï¼Œå¯¹äº‹åŠ¡æ€§è¦æ±‚ä¸é«˜

å¯¹äºè¿™æ ·çš„æ•°æ®ï¼Œæˆ‘ä»¬æ›´é€‚åˆä½¿ç”¨MongoDBæ¥å®ç°æ•°æ®çš„å­˜å‚¨ã€‚

### é€‰æ‹©ä¾æ® âœ…

- åº”ç”¨ä¸éœ€è¦äº‹åŠ¡åŠå¤æ‚ join æ”¯æŒ
- æ–°åº”ç”¨ï¼Œéœ€æ±‚ä¼šå˜ï¼Œæ•°æ®æ¨¡å‹æ— æ³•ç¡®å®šï¼Œæƒ³å¿«é€Ÿè¿­ä»£å¼€å‘
- åº”ç”¨éœ€è¦2000-3000ä»¥ä¸Šçš„è¯»å†™QPSï¼ˆæ›´é«˜ä¹Ÿå¯ä»¥ï¼‰
- åº”ç”¨éœ€è¦TBç”šè‡³ PB çº§åˆ«æ•°æ®å­˜å‚¨
- åº”ç”¨å‘å±•è¿…é€Ÿï¼Œéœ€è¦èƒ½å¿«é€Ÿæ°´å¹³æ‰©å±•
- åº”ç”¨è¦æ±‚å­˜å‚¨çš„æ•°æ®ä¸ä¸¢å¤±
- åº”ç”¨éœ€è¦99.999%é«˜å¯ç”¨
- åº”ç”¨éœ€è¦å¤§é‡çš„åœ°ç†ä½ç½®æŸ¥è¯¢ã€æ–‡æœ¬æŸ¥è¯¢


### MongoDB ç®€ä»‹ ğŸ“–

- MongoDBæ˜¯ä¸€ä¸ªå¼€æºã€é«˜æ€§èƒ½ã€æ— æ¨¡å¼çš„æ–‡æ¡£å‹æ•°æ®åº“ï¼Œå½“åˆçš„è®¾è®¡å°±æ˜¯ç”¨äºç®€åŒ–å¼€å‘å’Œæ–¹ä¾¿æ‰©å±•ï¼Œæ˜¯NoSQLæ•°æ®åº“äº§å“ä¸­çš„ä¸€ç§ã€‚æ˜¯æœ€åƒå…³ç³»å‹æ•°æ®åº“ï¼ˆMySQLï¼‰çš„éå…³ç³»å‹æ•°æ®åº“ã€‚
- å®ƒæ”¯æŒçš„æ•°æ®ç»“æ„éå¸¸æ¾æ•£ï¼Œæ˜¯ä¸€ç§ç±»ä¼¼äº JSON çš„ æ ¼å¼å«BSONï¼Œæ‰€ä»¥å®ƒæ—¢å¯ä»¥å­˜å‚¨æ¯”è¾ƒå¤æ‚çš„æ•°æ®ç±»å‹ï¼Œåˆç›¸å½“çš„çµæ´»ã€‚
- MongoDBä¸­çš„è®°å½•æ˜¯ä¸€ä¸ªæ–‡æ¡£ï¼Œå®ƒæ˜¯ä¸€ä¸ªç”±å­—æ®µå’Œå€¼å¯¹ï¼ˆfield:valueï¼‰ç»„æˆçš„æ•°æ®ç»“æ„ã€‚MongoDBæ–‡æ¡£ç±»ä¼¼äºJSONå¯¹è±¡ï¼Œå³ä¸€ä¸ªæ–‡æ¡£è®¤ä¸ºå°±æ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚å­—æ®µçš„æ•°æ®ç±»å‹æ˜¯å­—ç¬¦å‹ï¼Œå®ƒçš„å€¼é™¤äº†ä½¿ç”¨åŸºæœ¬çš„ä¸€äº›ç±»å‹å¤–ï¼Œè¿˜å¯ä»¥åŒ…æ‹¬å…¶ä»–æ–‡æ¡£ã€æ™®é€šæ•°ç»„å’Œæ–‡æ¡£æ•°ç»„ã€‚

### MongoDB ä½“ç³»ç»“æ„ ğŸ—ï¸

![img.png](imgs/img.png)

![img_1.png](imgs/img_1.png)

## MongoDB åŸºæœ¬å¸¸ç”¨å‘½ä»¤ âŒ¨ï¸

### æ•°æ®åº“æ“ä½œ ğŸ—„ï¸

#### 1.åˆ›å»ºå’Œé€‰æ‹©æ•°æ®åº“

```sql
use example_database
```


> åœ¨ MongoDB ä¸­ï¼Œé›†åˆåªæœ‰åœ¨å†…å®¹æ’å…¥åæ‰ä¼šåˆ›å»º! å°±æ˜¯è¯´ï¼Œåˆ›å»ºé›†åˆ(æ•°æ®è¡¨)åè¦å†æ’å…¥ä¸€ä¸ªæ–‡æ¡£(è®°å½•)ï¼Œé›†åˆæ‰ä¼šçœŸæ­£åˆ›å»ºã€‚

#### 2.æŸ¥çœ‹æœ‰æƒé™æŸ¥çœ‹çš„æ‰€æœ‰çš„æ•°æ®åº“å‘½ä»¤

```sql
show dbs
show databases
```


#### 3.æŸ¥çœ‹å½“å‰æ•°æ®åº“å‘½ä»¤

```sql
db
```


> MongoDB ä¸­é»˜è®¤çš„æ•°æ®åº“ä¸º testï¼Œå¦‚æœä½ æ²¡æœ‰é€‰æ‹©æ•°æ®åº“ï¼Œé›†åˆå°†å­˜æ”¾åœ¨ test æ•°æ®åº“ä¸­ã€‚

å¦å¤–ï¼š
- æ•°æ®åº“åå¯ä»¥æ˜¯æ»¡è¶³ä»¥ä¸‹æ¡ä»¶çš„ä»»æ„UTF-8å­—ç¬¦ä¸²ã€‚
- ä¸èƒ½æ˜¯ç©ºå­—ç¬¦ä¸²("")ã€‚
- ä¸å¾—å«æœ‰' '(ç©ºæ ¼)ã€. ã€$ ã€/ ã€\ å’Œ \0 (ç©ºå­—ç¬¦)ã€‚
- åº”å…¨éƒ¨å°å†™ã€‚
- æœ€å¤š64å­—èŠ‚ã€‚

æœ‰ä¸€äº›æ•°æ®åº“åæ˜¯ä¿ç•™çš„ï¼Œå¯ä»¥ç›´æ¥è®¿é—®è¿™äº›æœ‰ç‰¹æ®Šä½œç”¨çš„æ•°æ®åº“ã€‚
- adminï¼šä»æƒé™çš„è§’åº¦æ¥çœ‹ï¼Œè¿™æ˜¯"root"æ•°æ®åº“ã€‚è¦æ˜¯å°†ä¸€ä¸ªç”¨æˆ·æ·»åŠ åˆ°è¿™ä¸ªæ•°æ®åº“ï¼Œè¿™ä¸ªç”¨æˆ·è‡ªåŠ¨ç»§æ‰¿æ‰€æœ‰æ•°æ®åº“çš„æƒé™ã€‚ä¸€äº›ç‰¹å®šçš„æœåŠ¡å™¨ç«¯å‘½ä»¤ä¹Ÿåªèƒ½ä»è¿™ä¸ªæ•°æ®åº“è¿è¡Œï¼Œæ¯”å¦‚åˆ—å‡ºæ‰€æœ‰çš„æ•°æ®åº“æˆ–è€…å…³é—­æœåŠ¡å™¨ã€‚
- localï¼šè¿™ä¸ªæ•°æ®æ°¸è¿œä¸ä¼šè¢«å¤åˆ¶ï¼Œå¯ä»¥ç”¨æ¥å­˜å‚¨é™äºæœ¬åœ°å•å°æœåŠ¡å™¨çš„ä»»æ„é›†åˆ
- configï¼šå½“Mongoç”¨äºåˆ†ç‰‡è®¾ç½®æ—¶ï¼Œconfigæ•°æ®åº“åœ¨å†…éƒ¨ä½¿ç”¨ï¼Œç”¨äºä¿å­˜åˆ†ç‰‡çš„ç›¸å…³ä¿¡æ¯ã€‚

#### 4.æ•°æ®åº“çš„åˆ é™¤

```sql
db.dropDatabase()
```


### é›†åˆæ“ä½œ ğŸ“

#### 1.é›†åˆçš„æ˜¾å¼åˆ›å»º

```sql
db.createCollection(name)
```


å‚æ•°è¯´æ˜ï¼š
- name:è¦åˆ›å»ºçš„é›†åˆåç§°

é›†åˆçš„å‘½åè§„èŒƒï¼š
- é›†åˆåä¸èƒ½æ˜¯ç©ºå­—ç¬¦ä¸² "" ã€‚
- é›†åˆåä¸èƒ½å«æœ‰ \0 å­—ç¬¦(ç©ºå­—ç¬¦)ï¼Œè¿™ä¸ªå­—ç¬¦è¡¨ç¤ºé›†åˆåçš„ç»“å°¾ã€‚
- é›†åˆåä¸èƒ½ä»¥ "system." å¼€å¤´ï¼Œè¿™æ˜¯ä¸ºç³»ç»Ÿé›†åˆä¿ç•™çš„å‰ç¼€ã€‚
- ç”¨æˆ·åˆ›å»ºçš„é›†åˆåå­—ä¸èƒ½å«æœ‰ä¿ç•™å­—ç¬¦ã€‚æœ‰äº›é©±åŠ¨ç¨‹åºçš„ç¡®æ”¯æŒåœ¨é›†åˆåé‡Œé¢åŒ…å«ï¼Œè¿™æ˜¯å› ä¸ºæŸäº›ç³»ç»Ÿç”Ÿæˆçš„é›†åˆä¸­åŒ…å«è¯¥å­—ç¬¦ã€‚é™¤éä½ è¦è®¿é—®è¿™ç§ç³»ç»Ÿåˆ›å»ºçš„é›†åˆï¼Œå¦åˆ™åƒä¸‡ä¸è¦åœ¨åå­—é‡Œå‡ºç°$ã€‚

#### 2.æŸ¥çœ‹å½“å‰åº“ä¸­çš„è¡¨

```sql
show collections
show tables
```


#### 3.é›†åˆçš„éšå¼åˆ›å»º

MongoDB ä¸­é›†åˆåªæœ‰åœ¨å†…å®¹æ’å…¥åæ‰ä¼šåˆ›å»º! å°±æ˜¯è¯´ï¼Œåˆ›å»ºé›†åˆ(æ•°æ®è¡¨)åè¦å†æ’å…¥ä¸€ä¸ªæ–‡æ¡£(è®°å½•)ï¼Œé›†åˆæ‰ä¼šçœŸæ­£åˆ›å»º(éšå¼åˆ›å»º)ã€‚

#### 4.é›†åˆçš„åˆ é™¤

```sql
db.collection.drop()
db.é›†åˆ.drop()
```


> å¦‚æœæˆåŠŸåˆ é™¤é€‰å®šé›†åˆï¼Œåˆ™ drop() æ–¹æ³•è¿”å› trueï¼Œå¦åˆ™è¿”å› false

### æ–‡æ¡£åŸºæœ¬CRUD ğŸ”

#### 1.æ–‡æ¡£çš„æ’å…¥

```sql
db.collection.insert(
<document or array of documents>,
    {
        writeConcern: <document>,
        ordered: <boolean>
    }
)
```


å‚æ•°è¯´æ˜ï¼š
- document:è¦æ’å…¥çš„æ–‡æ¡£
- array of documents:è¦æ’å…¥çš„æ–‡æ¡£æ•°ç»„
- writeConcern:æŒ‡å®šå†™å…¥çš„é…ç½®
- ordered:æŒ‡å®šæ˜¯å¦æŒ‰é¡ºåºå†™å…¥

#### 2.æ‰¹é‡æ’å…¥

```sql
db.collection.insertMany(
    [ <document 1> , <document 2>, ... ],
    {
        writeConcern: <document>,
        ordered: <boolean>
    }
)
```


#### 3.æ–‡æ¡£çš„åŸºæœ¬æŸ¥è¯¢

```sql
db.collection.find()
db.collection.find({})
```


ä¾‹å¦‚ï¼š
```sql
db.comment.find({userid:'1003'})
db.comment.findOne({userid:'1003'})
```


#### 4.æŠ•å½±æŸ¥è¯¢(Projection Query) ğŸ¯

å¦‚æœè¦æŸ¥è¯¢ç»“æœè¿”å›éƒ¨åˆ†å­—æ®µï¼Œåˆ™éœ€è¦ä½¿ç”¨æŠ•å½±æŸ¥è¯¢ï¼ˆä¸æ˜¾ç¤ºæ‰€æœ‰å­—æ®µï¼Œåªæ˜¾ç¤ºæŒ‡å®šçš„å­—æ®µï¼‰

å¦‚ï¼šæŸ¥è¯¢ç»“æœåªæ˜¾ç¤º: _id ã€useridã€nickname:
```sql
db.comment.find({userid:"1003"},{userid:1,nickname:1})

{ "_id" : "4", "userid" : "1003", "nickname" : "å‡¯æ’’" }
{ "_id" : "5", "userid" : "1003", "nickname" : "å‡¯æ’’" }
```

é»˜è®¤ _id ä¼šæ˜¾ç¤ºã€‚

å¦‚ï¼šæŸ¥è¯¢ç»“æœåªæ˜¾ç¤º useridã€nicknameï¼Œä¸æ˜¾ç¤º _id ï¼š
```sql
db.comment.find({userid:"1003"},{userid:1,nickname:1,_id:0})

{ "userid" : "1003", "nickname" : "å‡¯æ’’" }
{ "userid" : "1003", "nickname" : "å‡¯æ’’" }
```

å†ä¾‹å¦‚ï¼šæŸ¥è¯¢æ‰€æœ‰æ•°æ®ï¼Œä½†åªæ˜¾ç¤º _id ã€useridã€nickname:

```sql
db.comment.find({},{userid:1,nickname:1})
```


#### 5.æ–‡æ¡£çš„æ›´æ–°

```sql
db.collection.update(query, update, options)

db.collection.update(
    <query>,
    <update>,
    {
        upsert: <boolean>,
        multi: <boolean>,
        writeConcern: <document>,
        collation: <document>,
        arrayFilters: [ <filterdocument1>, ... ],
        hint:  <document|string>        
    }
)
```


å‚æ•°è¯´æ˜ï¼š
- query: æŸ¥è¯¢æ¡ä»¶
- update: æ›´æ–°å†…å®¹
- options: æ›´æ–°é€‰é¡¹
- upsert: å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ–‡æ¡£ï¼Œæ˜¯å¦æ’å…¥æ–°çš„æ–‡æ¡£
- multi: æ˜¯å¦æ›´æ–°æ‰€æœ‰åŒ¹é…çš„æ–‡æ¡£
- writeConcern: æŒ‡å®šå†™å…¥çš„é…ç½®
- collation: æŒ‡å®šæ’åºè§„åˆ™
- arrayFilters: ç­›é€‰æ•°ç»„å…ƒç´ 
- hint: æŒ‡å®šç´¢å¼•


- è¦†ç›–ä¿®æ”¹

```sql
db.collection.update(
    {_id:"1"},{likenum:NumberInt(1001)}
)
```


- å±€éƒ¨ä¿®æ”¹

```sql
db.collection.update(
    {_id:"1"},{$set:{likenum:NumberInt(1001)}}
)
```


- æ‰¹é‡ä¿®æ”¹

```sql
//é»˜è®¤åªä¿®æ”¹ç¬¬ä¸€æ¡æ•°æ®
db.comment.update(
    {userid:"1003"},{$set:{nickname:"å‡¯æ’’2"}}
)

//ä¿®æ”¹æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®
db.comment.update(
    {userid:"1003"},{$set:{nickname:"å‡¯æ’’å¤§å¸"}},
    {multi:true}
)
```


- åˆ—å€¼å¢é•¿çš„ä¿®æ”¹

å¦‚æœæˆ‘ä»¬æƒ³å®ç°å¯¹æŸåˆ—å€¼åœ¨åŸæœ‰å€¼çš„åŸºç¡€ä¸Šè¿›è¡Œå¢åŠ æˆ–å‡å°‘ï¼Œå¯ä»¥ä½¿ç”¨ `$inc` è¿ç®—ç¬¦æ¥å®ç°ã€‚

éœ€æ±‚ï¼šå¯¹3å·æ•°æ®çš„ç‚¹èµæ•°ï¼Œæ¯æ¬¡é€’å¢1ï¼š
```sql
db.comment.update(
    {_id:"3"},{$inc:{likenum:NumberInt(1)}}
)
```
```sql
db.comment.update(
    {_id:"3"},{$inc:{likenum:NumberInt(1)}}
)
```


#### 6.æ–‡æ¡£çš„åˆ é™¤

```sql
db.collection.remove(query)

db.collection.remove(
    {}
)
```


### æ–‡æ¡£çš„åˆ†é¡µæŸ¥è¯¢ ğŸ“„

#### 1.ç»Ÿè®¡æŸ¥è¯¢

```sql
db.collection.count(query,options)
```


#### 2.åˆ†é¡µæŸ¥è¯¢

```sql
db.collection.find(query).skip(start).limit(pageSize)
```


#### 3.æ’åºæŸ¥è¯¢

```sql
db.collection.find(query).sort(sort)
```


#### 4.æ­£åˆ™çš„å¤æ‚æ¡ä»¶æŸ¥è¯¢

```sql
db.collection.find(
    {field:/æ­£åˆ™è¡¨è¾¾å¼/}
)

db.é›†åˆ.find(
    {å­—æ®µ:/æ­£åˆ™è¡¨è¾¾å¼/}
)
```


#### 5.æ¯”è¾ƒæŸ¥è¯¢

```sql
db.é›†åˆåç§°.find({ "field" : { $gt: value }}) // å¤§äº: field > value
db.é›†åˆåç§°.find({ "field" : { $lt: value }}) // å°äº: field < value
db.é›†åˆåç§°.find({ "field" : { $gte: value }}) // å¤§äºç­‰äº: field >= value
db.é›†åˆåç§°.find({ "field" : { $lte: value }}) // å°äºç­‰äº: field <= value
db.é›†åˆåç§°.find({ "field" : { $ne: value }}) // ä¸ç­‰äº: field != value
```


#### 6.åŒ…å«æŸ¥è¯¢

- åŒ…å«ä½¿ç”¨ï¼š`$in`

```sql
db.é›†åˆåç§°.find(
    { "field" : { $in: [value1, value2, ...] }}
)
```


- ä¸åŒ…å«ä½¿ç”¨ï¼š`$nin`

```sql
db.é›†åˆåç§°.find(
    { "field" : { $nin: [value1, value2, ...] }}
)
```


#### 7.æ¡ä»¶è¿æ¥æŸ¥è¯¢

- `$and`ï¼šé€»è¾‘ä¸

```sql
db.é›†åˆåç§°.find(
    { $and: [æ¡ä»¶1, æ¡ä»¶2, ...]}
)
```


- `$or`ï¼šé€»è¾‘æˆ–

```sql
db.é›†åˆåç§°.find(
    { $or: [æ¡ä»¶1, æ¡ä»¶2, ...]}
)
```


## ç´¢å¼• ğŸ—‚ï¸

### ç´¢å¼•æ¦‚è¿°

- ç´¢å¼•æ”¯æŒåœ¨MongoDBä¸­é«˜æ•ˆåœ°æ‰§è¡ŒæŸ¥è¯¢ã€‚å¦‚æœæ²¡æœ‰ç´¢å¼•ï¼ŒMongoDBå¿…é¡»æ‰§è¡Œå…¨é›†åˆæ‰«æï¼Œå³æ‰«æé›†åˆä¸­çš„æ¯ä¸ªæ–‡æ¡£ï¼Œä»¥é€‰æ‹©ä¸æŸ¥è¯¢è¯­å¥åŒ¹é…çš„æ–‡æ¡£ã€‚è¿™ç§æ‰«æå…¨é›†åˆçš„æŸ¥è¯¢æ•ˆç‡æ˜¯éå¸¸ä½çš„ï¼Œç‰¹åˆ«åœ¨å¤„ç†å¤§é‡çš„æ•°æ®æ—¶ï¼ŒæŸ¥è¯¢å¯ä»¥è¦èŠ±è´¹å‡ åç§’ç”šè‡³å‡ åˆ†é’Ÿï¼Œè¿™å¯¹ç½‘ç«™çš„æ€§èƒ½æ˜¯éå¸¸è‡´å‘½çš„ã€‚
- å¦‚æœæŸ¥è¯¢å­˜åœ¨é€‚å½“çš„ç´¢å¼•ï¼ŒMongoDBå¯ä»¥ä½¿ç”¨è¯¥ç´¢å¼•é™åˆ¶å¿…é¡»æ£€æŸ¥çš„æ–‡æ¡£æ•°ã€‚
- ç´¢å¼•æ˜¯ç‰¹æ®Šçš„æ•°æ®ç»“æ„ï¼Œå®ƒä»¥æ˜“äºéå†çš„å½¢å¼å­˜å‚¨é›†åˆæ•°æ®é›†çš„ä¸€å°éƒ¨åˆ†ã€‚ç´¢å¼•å­˜å‚¨ç‰¹å®šå­—æ®µæˆ–ä¸€ç»„å­—æ®µçš„å€¼ï¼ŒæŒ‰å­—æ®µå€¼æ’åºã€‚ç´¢å¼•é¡¹çš„æ’åºæ”¯æŒæœ‰æ•ˆçš„ç›¸ç­‰åŒ¹é…å’ŒåŸºäºèŒƒå›´çš„æŸ¥è¯¢æ“ä½œã€‚æ­¤å¤–ï¼ŒMongoDBè¿˜å¯ä»¥ä½¿ç”¨ç´¢å¼•ä¸­çš„æ’åºè¿”å›æ’åºç»“æœã€‚

> MongoDBç´¢å¼•ä½¿ç”¨Bæ ‘æ•°æ®ç»“æ„ï¼ˆç¡®åˆ‡çš„è¯´æ˜¯B-Treeï¼ŒMySQLæ˜¯B+Treeï¼‰

### ç´¢å¼•ç±»å‹ ğŸ§©

#### å•å­—æ®µç´¢å¼•

- MongoDBæ”¯æŒåœ¨æ–‡æ¡£çš„å•ä¸ªå­—æ®µä¸Šåˆ›å»ºç”¨æˆ·å®šä¹‰çš„å‡åº/é™åºç´¢å¼•ï¼Œç§°ä¸ºå•å­—æ®µç´¢å¼•ï¼ˆSingle Field Indexï¼‰ã€‚
- å¯¹äºå•ä¸ªå­—æ®µç´¢å¼•å’Œæ’åºæ“ä½œï¼Œç´¢å¼•é”®çš„æ’åºé¡ºåºï¼ˆå³å‡åºæˆ–é™åºï¼‰å¹¶ä¸é‡è¦ï¼Œå› ä¸ºMongoDBå¯ä»¥åœ¨ä»»ä½•æ–¹å‘ä¸Šéå†ç´¢å¼•ã€‚

![img_2.png](imgs/img_2.png)

#### å¤åˆç´¢å¼•

- MongoDBè¿˜æ”¯æŒå¤šä¸ªå­—æ®µçš„ç”¨æˆ·å®šä¹‰ç´¢å¼•ï¼Œå³å¤åˆç´¢å¼•ï¼ˆCompound Indexï¼‰ã€‚
- å¤åˆç´¢å¼•ä¸­åˆ—å‡ºçš„å­—æ®µé¡ºåºå…·æœ‰é‡è¦æ„ä¹‰ã€‚ä¾‹å¦‚ï¼Œå¦‚æœå¤åˆç´¢å¼•ç”± { userid: 1, score: -1 } ç»„æˆï¼Œåˆ™ç´¢å¼•é¦–å…ˆæŒ‰ userid æ­£åºæ’åºï¼Œç„¶ååœ¨æ¯ä¸ª userid çš„å€¼å†…ï¼Œå†åœ¨æŒ‰ score å€’åºæ’åºã€‚

![img_3.png](imgs/img_3.png)

#### å…¶ä»–ç´¢å¼•

åœ°ç†ç©ºé—´ç´¢å¼•ï¼ˆGeospatial Indexï¼‰ã€æ–‡æœ¬ç´¢å¼•ï¼ˆText Indexesï¼‰ã€å“ˆå¸Œç´¢å¼•ï¼ˆHashed Indexesï¼‰

- åœ°ç†ç©ºé—´ç´¢å¼•ï¼ˆGeospatial Indexï¼‰
    - ä¸ºäº†æ”¯æŒå¯¹åœ°ç†ç©ºé—´åæ ‡æ•°æ®çš„æœ‰æ•ˆæŸ¥è¯¢ï¼ŒMongoDBæä¾›äº†ä¸¤ç§ç‰¹æ®Šçš„ç´¢å¼•ï¼šè¿”å›ç»“æœæ—¶ä½¿ç”¨å¹³é¢å‡ ä½•çš„äºŒç»´ç´¢å¼•å’Œè¿”å›ç»“æœæ—¶ä½¿ç”¨çƒé¢å‡ ä½•çš„äºŒç»´çƒé¢ç´¢å¼•ã€‚
- æ–‡æœ¬ç´¢å¼•ï¼ˆText Indexesï¼‰
    - MongoDBæä¾›äº†ä¸€ç§æ–‡æœ¬ç´¢å¼•ç±»å‹ï¼Œæ”¯æŒåœ¨é›†åˆä¸­æœç´¢å­—ç¬¦ä¸²å†…å®¹ã€‚è¿™äº›æ–‡æœ¬ç´¢å¼•ä¸å­˜å‚¨ç‰¹å®šäºè¯­è¨€çš„åœæ­¢è¯ï¼ˆä¾‹å¦‚"the"ã€"a"ã€"or"ï¼‰ï¼Œè€Œå°†é›†åˆä¸­çš„è¯ä½œä¸ºè¯å¹²ï¼Œåªå­˜å‚¨æ ¹è¯ã€‚
- å“ˆå¸Œç´¢å¼•ï¼ˆHashed Indexesï¼‰
    - ä¸ºäº†æ”¯æŒåŸºäºæ•£åˆ—çš„åˆ†ç‰‡ï¼ŒMongoDBæä¾›äº†æ•£åˆ—ç´¢å¼•ç±»å‹ï¼Œå®ƒå¯¹å­—æ®µå€¼çš„æ•£åˆ—è¿›è¡Œç´¢å¼•ã€‚è¿™äº›ç´¢å¼•åœ¨å…¶èŒƒå›´å†…çš„å€¼åˆ†å¸ƒæ›´åŠ éšæœºï¼Œä½†åªæ”¯æŒç›¸ç­‰åŒ¹é…ï¼Œä¸æ”¯æŒåŸºäºèŒƒå›´çš„æŸ¥è¯¢ã€‚

### ç´¢å¼•çš„ç®¡ç†æ“ä½œ ğŸ”§

#### ç´¢å¼•çš„æŸ¥çœ‹

```sql
db.collection.getIndexes()

> db.comment.getIndexes()
[
    {
        "v" : 2,
        "key" : {
                "_id" : 1
        },
        "name" : "_id_",
        "ns" : "articledb.comment"
    }
]
```


#### ç´¢å¼•çš„åˆ›å»º

```sql
db.collection.createIndex(keys,options)
```


- keysï¼šç´¢å¼•çš„å­—æ®µå’Œç´¢å¼•é¡ºåºã€‚ç´¢å¼•å­—æ®µçš„é¡ºåºæ˜¯ç´¢å¼•å­—æ®µçš„å‡åºï¼ˆ1ï¼‰æˆ–é™åºï¼ˆ-1ï¼‰ã€‚ç´¢å¼•å­—æ®µçš„é¡ºåºå¯ä»¥çœç•¥ï¼Œé»˜è®¤ä¸ºå‡åºã€‚
- optionsï¼šç´¢å¼•çš„é€‰é¡¹ã€‚

![img_4.png](imgs/img_4.png)

> æ³¨æ„åœ¨ 3.0.0 ç‰ˆæœ¬å‰åˆ›å»ºç´¢å¼•æ–¹æ³•ä¸º `db.collection.ensureIndex()` ï¼Œä¹‹åçš„ç‰ˆæœ¬ä½¿ç”¨äº† `db.collection.createIndex()` æ–¹æ³•ï¼Œ`ensureIndex()` è¿˜èƒ½ç”¨ï¼Œä½†åªæ˜¯ `createIndex()` çš„åˆ«åã€‚

```sql
db.comment.createIndex({userid:1,nickname:-1})
{
        "createdCollectionAutomatically" : false,
        "numIndexesBefore" : 2,
        "numIndexesAfter" : 3,
        "ok" : 1
}
```


#### ç´¢å¼•çš„åˆ é™¤

- æŒ‡å®šç´¢å¼•çš„ç§»é™¤
```sql
db.collection.dropIndex(indexName)
```


- åˆ é™¤æ‰€æœ‰ç´¢å¼•

```sql
db.collection.dropIndexes()
```


### ç´¢å¼•çš„ä¼˜åŒ– ğŸš€

#### æ‰§è¡Œè®¡åˆ’

- åˆ†ææŸ¥è¯¢æ€§èƒ½ï¼ˆAnalyze Query Performanceï¼‰é€šå¸¸ä½¿ç”¨æ‰§è¡Œè®¡åˆ’ï¼ˆè§£é‡Šè®¡åˆ’ã€Explain Planï¼‰æ¥æŸ¥çœ‹æŸ¥è¯¢çš„æƒ…å†µï¼Œå¦‚æŸ¥è¯¢è€—è´¹çš„æ—¶é—´ã€æ˜¯å¦åŸºäºç´¢å¼•æŸ¥è¯¢ç­‰ã€‚

```sql
db.collection.find(query,options).explain(options)
```


#### æ¶µç›–çš„æŸ¥è¯¢

- Covered Queries å½“æŸ¥è¯¢æ¡ä»¶å’ŒæŸ¥è¯¢çš„æŠ•å½±ä»…åŒ…å«ç´¢å¼•å­—æ®µæ—¶ï¼ŒMongoDBç›´æ¥ä»ç´¢å¼•è¿”å›ç»“æœï¼Œè€Œä¸æ‰«æä»»ä½•æ–‡æ¡£æˆ–å°†æ–‡æ¡£å¸¦å…¥å†…å­˜ã€‚ è¿™äº›è¦†ç›–çš„æŸ¥è¯¢å¯ä»¥éå¸¸æœ‰æ•ˆã€‚

![img_5.png](imgs/img_5.png)