# Zookeeper ğŸ’

## é…ç½®ä¸­å¿ƒ ğŸ”§

- åº”ç”¨å¯åŠ¨æ—¶è¯»å–é…ç½®ä¿¡æ¯ï¼Œè¿›è¡Œåˆå§‹åŒ–ã€‚ä¼ ç»Ÿçš„å®ç°æ–¹å¼å°†é…ç½®å­˜å‚¨åœ¨æœ¬åœ°æ–‡ä»¶å’Œå†…å­˜ä¸­ï¼Œä¸€æ—¦æœºå™¨è§„æ¨¡æ›´å¤§ï¼Œé…ç½®å˜æ›´é¢‘ç¹æƒ…å†µä¸‹ï¼Œæœ¬åœ°æ–‡ä»¶å’Œå†…å­˜æ–¹å¼çš„é…ç½®ç»´æŠ¤æˆæœ¬è¾ƒé«˜ï¼Œä½¿ç”¨zookeeperä½œä¸ºåˆ†å¸ƒå¼çš„é…ç½®ä¸­å¿ƒå°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚
- æˆ‘ä»¬å°†é…ç½®ä¿¡æ¯å­˜åœ¨zkä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ä¸­ï¼ŒåŒæ—¶ç»™è¯¥èŠ‚ç‚¹æ³¨å†Œä¸€ä¸ªæ•°æ®èŠ‚ç‚¹å˜æ›´çš„watcherç›‘å¬ï¼Œä¸€æ—¦èŠ‚ç‚¹æ•°æ®å‘ç”Ÿå˜æ›´ï¼Œæ‰€æœ‰çš„è®¢é˜…è¯¥èŠ‚ç‚¹çš„å®¢æˆ·ç«¯éƒ½å¯ä»¥è·å–æ•°æ®å˜æ›´é€šçŸ¥ã€‚

## è´Ÿè½½å‡è¡¡ ğŸ”„

- å»ºç«‹serverèŠ‚ç‚¹ï¼Œå¹¶å»ºç«‹ç›‘å¬å™¨ç›‘è§†serverså­èŠ‚ç‚¹çš„çŠ¶æ€ï¼ˆç”¨äºåœ¨æœåŠ¡å™¨å¢æ·»æ—¶åŠæ—¶åŒæ­¥å½“å‰é›†ç¾¤ä¸­æœåŠ¡å™¨åˆ—è¡¨ï¼‰ã€‚åœ¨æ¯ä¸ªæœåŠ¡å™¨å¯åŠ¨æ—¶ï¼Œåœ¨serversèŠ‚ç‚¹ä¸‹å»ºç«‹å…·ä½“æœåŠ¡å™¨åœ°å€çš„å­èŠ‚ç‚¹,å¹¶åœ¨å¯¹åº”çš„å­—èŠ‚ç‚¹ä¸‹å­˜å…¥æœåŠ¡å™¨çš„ç›¸å…³ä¿¡æ¯ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬åœ¨zookeeperæœåŠ¡å™¨ä¸Šå¯ä»¥è·å–å½“å‰é›†ç¾¤ä¸­çš„æœåŠ¡å™¨åˆ—è¡¨åŠç›¸å…³ä¿¡æ¯ï¼Œå¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªè´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œåœ¨æ¯ä¸ªè¯·æ±‚è¿‡æ¥æ—¶ä»zookeeperæœåŠ¡å™¨ä¸­è·å–å½“å‰é›†ç¾¤æœåŠ¡å™¨åˆ—è¡¨ï¼Œæ ¹æ®ç®—æ³•é€‰å‡ºå…¶ä¸­ä¸€ä¸ªæœåŠ¡å™¨æ¥å¤„ç†è¯·æ±‚ã€‚

![1561446942681.png](img/1561446942681.png)

## å‘½åæœåŠ¡ ğŸ·ï¸

- å‘½åæœåŠ¡æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„åŸºæœ¬åŠŸèƒ½ä¹‹ä¸€ã€‚è¢«å‘½åçš„å®ä½“é€šå¸¸å¯ä»¥æ˜¯é›†ç¾¤ä¸­çš„æœºå™¨ã€æä¾›çš„æœåŠ¡åœ°å€æˆ–è€…è¿œç¨‹å¯¹è±¡ï¼Œè¿™äº›éƒ½å¯ä»¥ç§°ä½œä¸ºåå­—ã€‚å¸¸è§çš„å°±æ˜¯ä¸€äº›åˆ†å¸ƒå¼æœåŠ¡æ¡†æ¶ï¼ˆRPCã€RMIï¼‰ä¸­çš„æœåŠ¡åœ°å€åˆ—è¡¨ï¼Œé€šè¿‡ä½¿ç”¨åç§°æœåŠ¡å®¢æˆ·ç«¯å¯ä»¥è·å–èµ„æºçš„å®ä½“ã€æœåŠ¡åœ°å€å’Œæä¾›è€…ä¿¡æ¯ã€‚å‘½åæœåŠ¡å°±æ˜¯é€šè¿‡ä¸€ä¸ªèµ„æºå¼•ç”¨çš„æ–¹å¼æ¥å®ç°å¯¹èµ„æºçš„å®šä½å’Œä½¿ç”¨ã€‚åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œä¸Šå±‚åº”ç”¨ä»…ä»…éœ€è¦ä¸€ä¸ªå…¨å±€å”¯ä¸€åç§°ï¼Œå°±åƒæ•°æ®åº“ä¸­çš„ä¸»é”®ã€‚
- åœ¨å•åº“å•è¡¨ç³»ç»Ÿä¸­å¯ä»¥é€šè¿‡è‡ªå¢IDæ¥æ ‡è¯†æ¯ä¸€æ¡è®°å½•ï¼Œä½†æ˜¯éšç€è§„æ¨¡å˜å¤§åˆ†åº“åˆ†è¡¨å¾ˆå¸¸è§ï¼Œé‚£ä¹ˆè‡ªå¢IDæœ‰ä»…èƒ½é’ˆå¯¹å•ä¸€è¡¨ç”ŸæˆIDï¼Œæ‰€ä»¥åœ¨è¿™ç§æƒ…å†µä¸‹æ— æ³•ä¾é è¿™ä¸ªæ¥æ ‡è¯†å”¯ä¸€IDã€‚UUIDå°±æ˜¯ä¸€ç§å…¨å±€å”¯ä¸€æ ‡è¯†ç¬¦ã€‚ä½†æ˜¯é•¿åº¦è¿‡é•¿ä¸æ˜“è¯†åˆ«ã€‚

![1561447515374.png](img/1561447515374.png)

- åœ¨Zookeeperä¸­é€šè¿‡åˆ›å»ºé¡ºåºèŠ‚ç‚¹å°±å¯ä»¥å®ç°ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯éƒ½ä¼šæ ¹æ®è‡ªå·±çš„ä»»åŠ¡ç±»å‹æ¥åˆ›å»ºä¸€ä¸ªé¡ºåºèŠ‚ç‚¹ï¼Œä¾‹å¦‚ job-00000001
- èŠ‚ç‚¹åˆ›å»ºå®Œæ¯•åï¼Œcreate()æ¥å£ä¼šè¿”å›ä¸€ä¸ªå®Œæ•´çš„èŠ‚ç‚¹åï¼Œä¾‹å¦‚ï¼šjob-00000002
  - æ‹¼æ¥typeç±»å‹å’Œå®Œæ•´èŠ‚ç‚¹åä½œä¸ºå…¨å±€å”¯ä¸€çš„ID

## DNSæœåŠ¡ ğŸŒ

### åŸŸåé…ç½®

- åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿåº”ç”¨ä¸­ï¼Œæ¯ä¸€ä¸ªåº”ç”¨éƒ½éœ€è¦åˆ†é…ä¸€ä¸ªåŸŸåï¼Œæ—¥å¸¸å¼€å‘ä¸­ï¼Œå¾€å¾€ä½¿ç”¨æœ¬åœ°HOSTç»‘å®šåŸŸåè§£æï¼Œå¼€å‘é˜¶æ®µå¯ä»¥éšæ—¶ä¿®æ”¹åŸŸåå’ŒIPçš„æ˜ å°„ï¼Œå¤§å¤§æé«˜å¼€å‘çš„è°ƒè¯•æ•ˆç‡ã€‚å¦‚æœåº”ç”¨çš„æœºå™¨è§„æ¨¡è¾¾åˆ°ä¸€å®šç¨‹åº¦åï¼Œéœ€è¦é¢‘ç¹æ›´æ–°åŸŸåæ—¶ï¼Œéœ€è¦åœ¨è§„æ¨¡çš„é›†ç¾¤ä¸­å˜æ›´ï¼Œæ— æ³•ä¿è¯å®æ—¶æ€§ã€‚æ‰€æœ‰æˆ‘ä»¬åœ¨zkä¸Šåˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹æ¥è¿›è¡ŒåŸŸåé…ç½®

![1561449211922.png](img/1561449211922.png)

### åŸŸåè§£æ

- åº”ç”¨è§£ææ—¶ï¼Œé¦–å…ˆä»zkåŸŸåèŠ‚ç‚¹ä¸­è·å–åŸŸåæ˜ å°„çš„IPå’Œç«¯å£ã€‚

### åŸŸåå˜æ›´

- æ¯ä¸ªåº”ç”¨éƒ½ä¼šåœ¨åœ¨å¯¹åº”çš„åŸŸåèŠ‚ç‚¹æ³¨å†Œä¸€ä¸ªæ•°æ®å˜æ›´çš„watcherç›‘å¬ï¼Œä¸€æ—¦ç›‘å¬çš„åŸŸåèŠ‚ç‚¹æ•°æ®å˜æ›´ï¼Œzkä¼šå‘æ‰€æœ‰è®¢é˜…çš„å®¢æˆ·ç«¯å‘é€åŸŸåå˜æ›´é€šçŸ¥ã€‚

## é›†ç¾¤ç®¡ç† ğŸ‘¥

- éšç€åˆ†å¸ƒå¼ç³»ç»Ÿè§„æ¨¡æ—¥ç›Šæ‰©å¤§ï¼Œé›†ç¾¤ä¸­æœºå™¨çš„æ•°é‡è¶Šæ¥è¶Šå¤šã€‚æœ‰æ•ˆçš„é›†ç¾¤ç®¡ç†è¶Šæ¥è¶Šé‡è¦äº†ï¼Œzookeeperé›†ç¾¤ç®¡ç†ä¸»è¦åˆ©ç”¨äº†watcheræœºåˆ¶å’Œåˆ›å»ºä¸´æ—¶èŠ‚ç‚¹æ¥å®ç°ã€‚ä»¥æœºå™¨ä¸Šä¸‹çº¿å’Œæœºå™¨ç›‘æ§ä¸ºä¾‹ï¼š

### æœºå™¨ä¸Šä¸‹çº¿

- æ–°å¢æœºå™¨çš„æ—¶å€™ï¼Œå°†Agentéƒ¨ç½²åˆ°æ–°å¢çš„æœºå™¨ä¸Šï¼Œå½“Agentéƒ¨ç½²å¯åŠ¨æ—¶ï¼Œä¼šå‘zookeeperæŒ‡å®šçš„èŠ‚ç‚¹ä¸‹åˆ›å»ºä¸€ä¸ªä¸´æ—¶å­èŠ‚ç‚¹ï¼Œå½“Agentåœ¨zkä¸Šåˆ›å»ºå®Œè¿™ä¸ªä¸´æ—¶èŠ‚ç‚¹åï¼Œå½“å…³æ³¨çš„èŠ‚ç‚¹zookeeper/machinesä¸‹çš„å­èŠ‚ç‚¹æ–°åŠ å…¥æ–°çš„èŠ‚ç‚¹æ—¶æˆ–åˆ é™¤éƒ½ä¼šå‘é€é€šçŸ¥ï¼Œè¿™æ ·å°±å¯¹æœºå™¨çš„ä¸Šä¸‹çº¿è¿›è¡Œç›‘æ§ã€‚

![1561452028843.png](img/1561452028843.png)

### æœºå™¨ç›‘æ§

- åœ¨æœºå™¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼ŒAgentä¼šå®šæ—¶å°†ä¸»æœºçš„çš„è¿è¡ŒçŠ¶æ€ä¿¡æ¯å†™å…¥åˆ°/machines/hostnä¸»æœºèŠ‚ç‚¹ï¼Œç›‘æ§ä¸­å¿ƒé€šè¿‡è®¢é˜…è¿™äº›èŠ‚ç‚¹çš„æ•°æ®å˜åŒ–æ¥è·å–ä¸»æœºçš„è¿è¡Œä¿¡æ¯ã€‚

## åˆ†å¸ƒå¼é” ğŸ”’

### æ•°æ®åº“å®ç°åˆ†å¸ƒå¼é”

1. åˆ›å»ºä¸€å¼ é”è¡¨

```sql
CREATE TABLE `lock_record` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®',
  `lock_name` varchar(64) NOT NULL COMMENT 'é”åç§°',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_lock_name` (`lock_name`)
) ENGINE=InnoDB AUTO_INCREMENT=38 DEFAULT CHARSET=utf8mb4 COLLT=utf8mb4_unicode_ci;
```


2. å®šä¹‰é”ï¼Œå®ç°Lockæ¥å£ï¼ŒtryLock()å°è¯•è·å–é”ï¼Œä»é”è¡¨ä¸­æŸ¥è¯¢æŒ‡å®šçš„é”è®°å½•ï¼Œå¦‚æœæŸ¥è¯¢åˆ°è®°å½•ï¼Œè¯´æ˜å·²ç»ä¸Šé”ï¼Œä¸èƒ½å†ä¸Šé”

```java
@Override
public boolean tryLock() {
    Example example = new Example(LockRecord.class);
    example.createCriteria().andEqualTo("lockName", LOCK_NAME);
    LockRecord lockRecord = lockRecordMapper.selectOneByExample(example);
    if (lockRecord == null) {
        return true;
    }
    return false;
}
```


3. åœ¨lockæ–¹æ³•è·å–é”ä¹‹å‰å…ˆè°ƒç”¨tryLock()æ–¹æ³•å°è¯•è·å–é”ï¼Œå¦‚æœæœªåŠ é”åˆ™å‘é”è¡¨ä¸­æ’å…¥ä¸€æ¡é”è®°å½•æ¥è·å–é”ï¼Œè¿™é‡Œæˆ‘ä»¬é€šè¿‡å¾ªç¯ï¼Œå¦‚æœä¸Šé”æˆ‘ä»¬ä¸€è‡´ç­‰å¾…é”çš„é‡Šæ”¾

```java
public void lock() {
    while (true) {
        if (tryLock()) {
            LockRecord lockRecord = new LockRecord();
            lockRecord.setLockName(LOCK_NAME);
            lockRecordMapper.insert(lockRecord);
            return;
        } else {
            System.out.println("ç­‰å¾…é”......");
        }
    }
}
```


4. é‡Šæ”¾é”ï¼Œå³æ˜¯å°†æ•°æ®åº“ä¸­å¯¹åº”çš„é”è¡¨è®°å½•åˆ é™¤

```java
public void unlock() {
    Example example = new Example(LockRecord.class);
    example.createCriteria().andEqualTo("lockName", LOCK_NAME);
    lockRecordMapper.deleteByExample(example);
}
```


> æ³¨æ„åœ¨å°è¯•è·å–é”çš„æ–¹æ³•tryLockä¸­ï¼Œå­˜åœ¨å¤šä¸ªçº¿ç¨‹åŒæ—¶è·å–é”çš„æƒ…å†µï¼Œå¯ä»¥ç®€å•é€šè¿‡synchronizedè§£å†³

### Rediså®ç°åˆ†å¸ƒå¼é” ğŸ’¾

- redisåˆ†å¸ƒå¼é”çš„å®ç°åŸºäºsetnxï¼ˆset if not existsï¼‰ï¼Œè®¾ç½®æˆåŠŸï¼Œè¿”å›1ï¼›è®¾ç½®å¤±è´¥ï¼Œè¿”å›0ï¼Œé‡Šæ”¾é”çš„æ“ä½œé€šè¿‡delæŒ‡ä»¤æ¥å®Œæˆ
- å¦‚æœè®¾ç½®é”ååœ¨æ‰§è¡Œä¸­é—´è¿‡ç¨‹æ—¶ï¼Œç¨‹åºæŠ›å‡ºå¼‚å¸¸ï¼Œå¯¼è‡´delæŒ‡ä»¤æ²¡æœ‰è°ƒç”¨ï¼Œé”æ°¸è¿œæ— æ³•é‡Šæ”¾ï¼Œè¿™æ ·å°±ä¼šé™·å…¥æ­»é”ã€‚æ‰€ä»¥æˆ‘ä»¬æ‹¿åˆ°é”ä¹‹åä¼šç»™é”åŠ ä¸Šä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Œè¿™æ ·å³ä½¿ä¸­é—´å‡ºç°å¼‚å¸¸ï¼Œè¿‡æœŸæ—¶é—´åˆ°åä¼šè‡ªåŠ¨é‡Šæ”¾é”ã€‚
- åŒæ—¶åœ¨setnx å’Œ expire å¦‚æœè¿›ç¨‹æŒ‚æ‰ï¼Œexpireä¸èƒ½æ‰§è¡Œä¹Ÿä¼šæ­»é”ã€‚æ‰€ä»¥è¦ä¿è¯setnxå’Œexpireæ˜¯ä¸€ä¸ªåŸå­æ€§æ“ä½œå³å¯ã€‚redis 2.8ä¹‹åæ¨å‡ºäº†setnxå’Œexpireçš„ç»„åˆæŒ‡ä»¤

  ```redis
  set key value ex 5 nx
  ```


#### Rediså®ç°åˆ†å¸ƒå¼é”æ³¨æ„çš„äº‹é¡¹

1. lockè·å–é”æ–¹æ³•

```java
while (true) {
    // æ³¨æ„ç‰ˆæœ¬
    Boolean f = redisTemplate.opsForValue().setIfAbsent(LOCK_KEY_NAME, LOCK_NAME, 10, TimeUnit.SECONDS);
    if (f) {
        return;
    } else {
        System.out.println("ç­‰å¾…é”......");
    }
}
```


2. é‡Šæ”¾é”

```java
    redisTemplate.delete(LOCK_KEY_NAME);
```


> rediså®ç°åˆ†å¸ƒå¼é”å­˜åœ¨çš„é—®é¢˜ï¼Œä¸ºäº†è§£å†³rediså•ç‚¹é—®é¢˜ï¼Œæˆ‘ä»¬ä¼šéƒ¨ç½²redisé›†ç¾¤ï¼Œåœ¨ Sentinel é›†ç¾¤ä¸­ï¼Œä¸»èŠ‚ç‚¹çªç„¶æŒ‚æ‰äº†ã€‚åŒæ—¶ä¸»èŠ‚ç‚¹ä¸­æœ‰æŠŠé”è¿˜æ²¡æœ‰æ¥å¾—åŠåŒæ­¥åˆ°ä»èŠ‚ç‚¹ã€‚è¿™æ ·å°±ä¼šå¯¼è‡´ç³»ç»Ÿä¸­åŒæ ·ä¸€æŠŠé”è¢«ä¸¤ä¸ªå®¢æˆ·ç«¯åŒæ—¶æŒæœ‰ï¼Œä¸å®‰å…¨æ€§ç”±æ­¤äº§ç”Ÿã€‚rediså®˜æ–¹ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ¨å‡ºäº†Redlock ç®—æ³•è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ä½†æ˜¯å¸¦æ¥çš„ç½‘ç»œæ¶ˆè€—è¾ƒå¤§ã€‚

#### åˆ†å¸ƒå¼é”çš„ Redisson å®ç°

1. æ·»åŠ ä¾èµ–

```xml
    <dependency>
      <groupId>org.redisson</groupId>
      <artifactId>redisson</artifactId>
      <version>3.6.5</version>
    </dependency>
```


2. è·å–é”é‡Šæ”¾é”

```java
    Config config = new Config();
    config.useSingleServer()
          .setAddress("redis://127.0.0.1:6379")
          .setDatabase(0);
    Redisson redisson = (Redisson) Redisson.create(config);
    RLock mylock = redisson.getLock(key); //è·å–é”
    mylock.lock();
    // èµ„æºæ“ä½œ...
    mylock.unlock();
```


### Zookeeperå®ç°åˆ†å¸ƒå¼é” ğŸ§©

- åŸç†ï¼šæœ‰åºä¸´æ—¶èŠ‚ç‚¹ + watch ç›‘å¬

![img.png](img/img.png)

1. åˆ›å»ºé”èŠ‚ç‚¹

```java
public class ZkLock implements Lock {
  // zkå®¢æˆ·ç«¯
  private ZooKeeper zk;
  // zkæ˜¯ä¸€ä¸ªç›®å½•ç»“æ„ï¼Œrootä¸ºæœ€å¤–å±‚ç›®å½•
  private String root = "/locks";
  // é”çš„åç§°
  private String lockName;
  // å½“å‰çº¿ç¨‹åˆ›å»ºçš„åºåˆ—node
  private ThreadLocal<String> nodeId = new ThreadLocal<>();
  // ç”¨æ¥åŒæ­¥ç­‰å¾…zkclienté“¾æ¥åˆ°äº†æœåŠ¡ç«¯
  private CountDownLatch connectedSignal = new CountDownLatch(1);
  private final static int sessionTimeout = 3000;
  private final static byte[] data = new byte[0];

  public ZkLock(String config, String lockName) {
    this.lockName = lockName;
    try {
      zk = new ZooKeeper(config, sessionTimeout, new Watcher() {
        @Override
        public void process(WatchedEvent event) {
          if (event.getState() == Event.KeeperState.SyncConnected) {
            // æ³¨å†Œ Watcher ç›‘å¬å™¨ï¼Œå½“è¿æ¥å»ºç«‹æˆåŠŸæ—¶è§¦å‘ CountDownLatch è®¡æ•°å‡ä¸€
            connectedSignal.countDown();
          }
        }
      });
      // é˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ° ZooKeeper å®¢æˆ·ç«¯è¿æ¥åˆ°æœåŠ¡å™¨ç¡®ä¿åç»­æ“ä½œåœ¨è¿æ¥å»ºç«‹åæ‰§è¡Œ
      connectedSignal.await();
      Stat stat = zk.exists(root, false);
      if (null == stat) {
        // åˆ›å»ºæ ¹èŠ‚ç‚¹
        // ä½¿ç”¨ OPEN_ACL_UNSAFE è¡¨ç¤ºæ— é™åˆ¶è®¿é—®æƒé™
        zk.create(root, data, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
      }
    } catch (Exception e) {
      throw new RuntimeException(e);
    }
  }
}
```


2. æ·»åŠ watchç›‘å¬ä¸´æ—¶é¡ºåºèŠ‚ç‚¹çš„åˆ é™¤

```java
class LockWatcher implements Watcher {
    private CountDownLatch latch = null;
    
    public LockWatcher(CountDownLatch latch) {
        this.latch = latch;
    }
    
    @Override
    public void process(WatchedEvent event) {
        if (event.getType() == Event.EventType.NodeDeleted) {
            latch.countDown();
        }
    }
}
```


3. è·å–é”æ“ä½œ

```java
@Override
public void lock() {
    try {
        // CreateMode.EPHEMERAL_SEQUENTIALï¼šä¸´æ—¶é¡ºåºèŠ‚ç‚¹
        zk.create(root + "/" + lockName, data, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL);
        System.out.println(Thread.currentThread().getName() + myNode + " created");
    
        // å–å‡ºæ‰€æœ‰å­èŠ‚ç‚¹
        List<String> subNodes = zk.getChildren(root, false);
        TreeSet<String> sortedNodes = new TreeSet<>();
        for (String node : subNodes) {
          sortedNodes.add(root + "/" + node);
        }
        String smallNode = sortedNodes.first();
        String preNode = sortedNodes.lower(myNode);
    
        if (myNode.equals(smallNode)) {
          // å¦‚æœæ˜¯æœ€å°çš„èŠ‚ç‚¹,åˆ™è¡¨ç¤ºå–å¾—é”
          System.out.println(Thread.currentThread().getName() + myNode + " get lock");
          this.nodeId.set(myNode);
          return;
        }
    
        CountDownLatch latch = new CountDownLatch(1);
        Stat stat = zk.exists(preNode, new LockWatcher(latch));// åŒæ—¶æ³¨å†Œç›‘å¬ã€‚
    
        // åˆ¤æ–­æ¯”è‡ªå·±å°ä¸€ä¸ªæ•°çš„èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨,å¦‚æœä¸å­˜åœ¨åˆ™æ— éœ€ç­‰å¾…é”,åŒæ—¶æ³¨å†Œç›‘å¬
        if (stat != null) {
          System.out.println(Thread.currentThread().getName() + myNode +
                  " waiting for " + root + "/" + preNode + " released lock");
          latch.await();// ç­‰å¾…ï¼Œè¿™é‡Œåº”è¯¥ä¸€ç›´ç­‰å¾…å…¶ä»–çº¿ç¨‹é‡Šæ”¾é”
          nodeId.set(myNode);
          latch = null;
        }
    } catch (Exception e) {
        throw new RuntimeException(e);
    }
}
```


4. é‡Šæ”¾é”

```java
public void unlock() {
    try {
        System.out.println(Thread.currentThread().getName() + " unlock ");
        if (null != nodeId) {
            zk.delete(nodeId.get(), -1);
        }
        nodeId.remove();
    } catch (InterruptedException e) {
        e.printStackTrace();
    } catch (KeeperException e) {
        e.printStackTrace();
    }
}

```


### åŸºäº Curator å®ç°åˆ†å¸ƒå¼é” ğŸ§ª

1. æ·»åŠ ä¾èµ–

```xml
    <dependency>
        <groupId>org.apache.curator</groupId>
        <artifactId>curator-recipes</artifactId>
        <version>4.0.0</version>
    </dependency>
```


2. é”æ“ä½œ

```java
    // åˆ›å»ºzookeeperçš„å®¢æˆ·ç«¯
    RetryPolicy retryPolicy = new ExponentialBackoffRetry(1000, 3);
    // é›†ç¾¤é€šè¿‡ï¼Œåˆ†å‰²
    CuratorFramework client = CuratorFrameworkFactory.newClient("127.0.0.1:2181", retryPolicy);
    client.start();
    
    // åˆ›å»ºåˆ†å¸ƒå¼é”, é”ç©ºé—´çš„æ ¹èŠ‚ç‚¹è·¯å¾„ä¸º/curator/lock
    InterProcessMutex mutex = new InterProcessMutex(client, "/curator/lock");
    mutex.acquire(); // è·å¾—äº†é”, è¿›è¡Œä¸šåŠ¡æµç¨‹
    // ......
    // å®Œæˆä¸šåŠ¡æµç¨‹, é‡Šæ”¾é”
    mutex.release();
    
    // å…³é—­å®¢æˆ·ç«¯
    client.close();
```


## åˆ†å¸ƒå¼é˜Ÿåˆ— ğŸ“

- é˜Ÿåˆ—ç‰¹æ€§ï¼šFIFOï¼ˆå…ˆå…¥å…ˆå‡ºï¼‰ï¼Œzookeeperå®ç°åˆ†å¸ƒå¼é˜Ÿåˆ—çš„æ­¥éª¤ï¼š

- åœ¨é˜Ÿåˆ—èŠ‚ç‚¹ä¸‹åˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹ ä¾‹å¦‚/queue_info/192.168.1.1-0000001
- è°ƒç”¨getChildren()æ¥å£æ¥è·å–/queue_infoèŠ‚ç‚¹ä¸‹æ‰€æœ‰å­èŠ‚ç‚¹ï¼Œè·å–é˜Ÿåˆ—ä¸­æ‰€æœ‰å…ƒç´ 
- æ¯”è¾ƒè‡ªå·±èŠ‚ç‚¹æ˜¯å¦æ˜¯åºå·æœ€å°çš„èŠ‚ç‚¹ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™ç­‰å¾…å…¶ä»–èŠ‚ç‚¹å‡ºé˜Ÿåˆ—ï¼Œåœ¨åºå·æœ€å°çš„èŠ‚ç‚¹æ³¨å†Œ watcher
- è·å–watcheré€šçŸ¥åï¼Œé‡å¤æ­¥éª¤

![1561453271019.png](img/1561453271019.png)

![1561455432780.png](img/1561455432780.png)