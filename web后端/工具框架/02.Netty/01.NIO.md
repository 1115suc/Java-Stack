# ğŸš€ NIO ç¬”è®°

## ä¸€ã€ä¸‰å¤§æ ¸å¿ƒç»„ä»¶ ğŸ§©

### 1. Channel & Buffer ğŸ”—

- `channel` æœ‰ä¸€ç‚¹ç±»ä¼¼äº `stream`ï¼Œå®ƒå°±æ˜¯è¯»å†™æ•°æ®çš„**åŒå‘é€šé“**ï¼Œå¯ä»¥ä» `channel` å°†æ•°æ®è¯»å…¥ `buffer`ï¼Œä¹Ÿå¯ä»¥å°† `buffer` çš„æ•°æ®å†™å…¥ `channel`ï¼Œè€Œä¹‹å‰çš„ `stream` è¦ä¹ˆæ˜¯è¾“å…¥ï¼Œè¦ä¹ˆæ˜¯è¾“å‡ºï¼Œ`channel` æ¯” `stream` æ›´ä¸ºåº•å±‚

```mermaid
graph LR
channel --> buffer
buffer --> channel
```


å¸¸è§ `Channel` ç±»å‹ï¼š

- **FileChannel** - æ–‡ä»¶æ“ä½œé€šé“
- **DatagramChannel** - UDPç½‘ç»œé€šä¿¡é€šé“
- **SocketChannel** - TCPå®¢æˆ·ç«¯é€šé“
- **ServerSocketChannel** - TCPæœåŠ¡ç«¯é€šé“

> ğŸ’¡ **å°æç¤º**: Channel æ˜¯åŒå‘çš„ï¼Œå¯ä»¥åŒæ—¶è¿›è¡Œè¯»å†™æ“ä½œ

`buffer` åˆ™ç”¨æ¥ç¼“å†²è¯»å†™æ•°æ®ï¼Œå¸¸è§çš„ `buffer` æœ‰ï¼š

- **ByteBuffer** (æœ€å¸¸ç”¨)
  - MappedByteBuffer - å†…å­˜æ˜ å°„ç¼“å†²åŒº
  - DirectByteBuffer - ç›´æ¥ç¼“å†²åŒº
  - HeapByteBuffer - å †ç¼“å†²åŒº
- **ShortBuffer** - çŸ­æ•´å‹ç¼“å†²åŒº
- **IntBuffer** - æ•´å‹ç¼“å†²åŒº
- **LongBuffer** - é•¿æ•´å‹ç¼“å†²åŒº
- **FloatBuffer** - æµ®ç‚¹å‹ç¼“å†²åŒº
- **DoubleBuffer** - åŒç²¾åº¦æµ®ç‚¹å‹ç¼“å†²åŒº
- **CharBuffer** - å­—ç¬¦ç¼“å†²åŒº

### 2. Selector ğŸ¯

- `Selector` æ˜¯ä¸€ä¸ªå¤šè·¯å¤ç”¨å™¨ï¼Œ`Selector` å¯ä»¥åŒæ—¶ç›‘æ§å¤šä¸ª `channel`ï¼Œå½“æŸä¸ª `channel` ä¸Šçš„æ•°æ®å¯ä»¥è¯»å†™æ—¶ï¼Œ`Selector` å°±ä¼šè¿”å›è¿™ä¸ª `channel`ï¼Œä»è€Œå®ç°éé˜»å¡ IO

```mermaid
graph TD
subgraph selector ç‰ˆ
thread --> selector
selector --> c1(channel)
selector --> c2(channel)
selector --> c3(channel)
end
```


> ğŸ” **å·¥ä½œåŸç†**: è°ƒç”¨ selector çš„ select() ä¼šé˜»å¡ç›´åˆ° channel å‘ç”Ÿäº†è¯»å†™å°±ç»ªäº‹ä»¶ï¼Œè¿™äº›äº‹ä»¶å‘ç”Ÿï¼Œselect æ–¹æ³•å°±ä¼šè¿”å›è¿™äº›äº‹ä»¶äº¤ç»™ thread æ¥å¤„ç†

> âš¡ **ä¼˜åŠ¿**: ä¸€ä¸ªçº¿ç¨‹å¯ä»¥ç®¡ç†å¤šä¸ªè¿æ¥ï¼Œæé«˜ç³»ç»Ÿæ•ˆç‡

## äºŒã€ByteBuffer è¯¦è§£ ğŸ“¦

### 1. åŸºæœ¬ä½¿ç”¨æ–¹æ³•

```java
@Slf4j
public class ByteBufferDemo {
    public static void main(String[] args) {
        try (RandomAccessFile file = new RandomAccessFile("helloword/data.txt", "rw")) {
            FileChannel channel = file.getChannel();
            ByteBuffer buffer = ByteBuffer.allocate(10);
            do {
                // å‘ buffer å†™å…¥
                int len = channel.read(buffer);
                log.debug("è¯»åˆ°å­—èŠ‚æ•°ï¼š{}", len);
                if (len == -1) {
                    break;
                }
                // åˆ‡æ¢ buffer è¯»æ¨¡å¼
                buffer.flip();
                while(buffer.hasRemaining()) {
                    log.debug("{}", (char)buffer.get());
                }
                // åˆ‡æ¢ buffer å†™æ¨¡å¼
                buffer.clear();
            } while (true);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```


**æ ¸å¿ƒæ“ä½œæµç¨‹**ï¼š

1. ğŸ“¥ å‘ buffer å†™å…¥æ•°æ®ï¼Œä¾‹å¦‚è°ƒç”¨ channel.read(buffer)
2. ğŸ”„ è°ƒç”¨ flip() åˆ‡æ¢è‡³**è¯»æ¨¡å¼**
3. ğŸ“¤ ä» buffer è¯»å–æ•°æ®ï¼Œä¾‹å¦‚è°ƒç”¨ buffer.get()
4. ğŸ”„ è°ƒç”¨ clear() æˆ– compact() åˆ‡æ¢è‡³**å†™æ¨¡å¼**
5. ğŸ” é‡å¤ 1~4 æ­¥éª¤

### 2. ByteBuffer çš„å†…éƒ¨ç»“æ„ ğŸ—ï¸

ByteBuffer æœ‰ä»¥ä¸‹é‡è¦å±æ€§ï¼š

- **capacity** - å®¹é‡ï¼Œç¼“å†²åŒºçš„æ€»å¤§å°
- **position** - ä½ç½®ï¼Œå½“å‰è¯»å†™ä½ç½®
- **limit** - é™åˆ¶ï¼Œè¯»å†™çš„è¾¹ç•Œ

**åˆå§‹çŠ¶æ€**ï¼š

![](img/0021.png)

**å†™æ¨¡å¼ä¸‹**ï¼Œposition æ˜¯å†™å…¥ä½ç½®ï¼Œlimit ç­‰äºå®¹é‡ï¼Œä¸‹å›¾è¡¨ç¤ºå†™å…¥äº† 4 ä¸ªå­—èŠ‚åçš„çŠ¶æ€ï¼š

![](img/0018.png)

**flip åŠ¨ä½œå‘ç”Ÿå**ï¼Œposition åˆ‡æ¢ä¸ºè¯»å–ä½ç½®ï¼Œlimit åˆ‡æ¢ä¸ºè¯»å–é™åˆ¶ï¼š

![](img/0019.png)

**è¯»å– 4 ä¸ªå­—èŠ‚å**ï¼ŒçŠ¶æ€ï¼š

![](img/0020.png)

**clear åŠ¨ä½œå‘ç”Ÿå**ï¼ŒçŠ¶æ€ï¼š

![](img/0021.png)

**compact æ–¹æ³•**ï¼Œæ˜¯æŠŠæœªè¯»å®Œçš„éƒ¨åˆ†å‘å‰å‹ç¼©ï¼Œç„¶ååˆ‡æ¢è‡³å†™æ¨¡å¼ï¼š

![](img/0022.png)

### 3. ByteBuffer å¸¸è§æ–¹æ³• ğŸ› ï¸

#### (1). åˆ†é…ç©ºé—´ ğŸ—ï¸

- å¯ä»¥ä½¿ç”¨ allocate æ–¹æ³•ä¸º ByteBuffer åˆ†é…ç©ºé—´ (å †ç¼“å†²åŒº)

```java
    ByteBuffer buffer = ByteBuffer.allocate(1024);
```


- allocateDirect æ–¹æ³•ä¸º DirectByteBuffer åˆ†é…ç©ºé—´ (ç›´æ¥ç¼“å†²åŒº)

```java
    ByteBuffer buffer = ByteBuffer.allocateDirect(1024);
```


> ğŸ’¡ **åŒºåˆ«**: ç›´æ¥ç¼“å†²åŒºåœ¨å †å¤–åˆ†é…ï¼Œé€‚åˆé¢‘ç¹çš„IOæ“ä½œï¼›å †ç¼“å†²åŒºåœ¨JVMå †å†…åˆ†é…ï¼Œå—GCç®¡ç†

#### (2). å†™å…¥æ•°æ® ğŸ“¥

- è°ƒç”¨ channel çš„ read æ–¹æ³•

```java
    int readBytes = channel.read(buf);
```


- è°ƒç”¨ buffer è‡ªå·±çš„ put æ–¹æ³•

```java
    buf.put((byte)127);
```


#### (3). è¯»å–æ•°æ® ğŸ“¤

- è°ƒç”¨ channel çš„ write æ–¹æ³•

```java
    int writeBytes = channel.write(buf);
```


- è°ƒç”¨ buffer è‡ªå·±çš„ get æ–¹æ³•

```java
    byte b = buf.get();
```


get æ–¹æ³•ä¼šè®© position è¯»æŒ‡é’ˆå‘åèµ°ï¼Œå¦‚æœæƒ³é‡å¤è¯»å–æ•°æ®ï¼š

- å¯ä»¥è°ƒç”¨ rewind æ–¹æ³•å°† position é‡æ–°ç½®ä¸º 0
- æˆ–è€…è°ƒç”¨ get(int i) æ–¹æ³•è·å–ç´¢å¼• i çš„å†…å®¹ï¼Œå®ƒä¸ä¼šç§»åŠ¨è¯»æŒ‡é’ˆ

#### (4). åˆ‡æ¢æ¨¡å¼ ğŸ”„

- è°ƒç”¨ flip() æ–¹æ³•åˆ‡æ¢è‡³è¯»æ¨¡å¼
- è°ƒç”¨ clear() æ–¹æ³•åˆ‡æ¢è‡³å†™æ¨¡å¼
- è°ƒç”¨ compact() æ–¹æ³•åˆ‡æ¢è‡³å†™æ¨¡å¼ï¼Œä½†æ•°æ®æœªè¯»å®Œï¼Œæ•°æ®ä¼šè¢«å‘å‰å‹ç¼©

#### (5). mark å’Œ reset ğŸ¯

- mark æ˜¯åœ¨è¯»å–æ—¶ï¼Œåšä¸€ä¸ªæ ‡è®°ï¼Œå³ä½¿ position æ”¹å˜ï¼Œåªè¦è°ƒç”¨ reset å°±èƒ½å›åˆ° mark çš„ä½ç½®

> âš ï¸ æ³¨æ„: rewind å’Œ flip éƒ½ä¼šæ¸…é™¤ mark ä½ç½®

#### (6). å­—ç¬¦ä¸²ä¸ ByteBuffer äº’è½¬ ğŸ”„

- è°ƒç”¨ getBytes() æ–¹æ³•

```java
    byte[] bytes = "hello".getBytes();
    ByteBuffer buffer = ByteBuffer.allocate(1024);
    buffer.put(bytes);
```


- è°ƒç”¨ wrap() æ–¹æ³•

```java
    ByteBuffer buffer = ByteBuffer.wrap("hello".getBytes());
```


- Charset

```java
    ByteBuffer buffer = StandardCharsets.UTF_8.encode("hello");
```


> ğŸ’¡ **æç¤º**: ä½¿ç”¨ wrap() å’Œ Charset åï¼Œposition è¯»æŒ‡é’ˆå’Œ limit è¯»é™åˆ¶ä¼šè‡ªåŠ¨è®¾ç½®
> ä½¿ç”¨ getBytes() æ–¹æ³•åï¼Œposition è¯»æŒ‡é’ˆä¸ä¼šè‡ªåŠ¨è®¾ç½®ï¼Œéœ€è¦æ‰‹åŠ¨è°ƒç”¨ flip() è®¾ç½®

#### (7). Buffer çš„çº¿ç¨‹å®‰å…¨ ğŸ”’

- Buffer æ˜¯**éçº¿ç¨‹å®‰å…¨çš„**ï¼Œä¸èƒ½åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«

### 4. Scattering Reads åˆ†æ•£è¯»å– ğŸ“š

- åˆ†æ•£è¯»å–æ˜¯æŒ‡ä» channel ä¸­è¯»å–æ•°æ®åˆ°å¤šä¸ª buffer ä¸­

```java
    try (RandomAccessFile file = new RandomAccessFile("helloword/3parts.txt", "rw")) {
        FileChannel channel = file.getChannel();
        ByteBuffer a = ByteBuffer.allocate(3);
        ByteBuffer b = ByteBuffer.allocate(3);
        ByteBuffer c = ByteBuffer.allocate(5);
        channel.read(new ByteBuffer[]{a, b, c});
    } catch (IOException e) {
        e.printStackTrace();
    }
```


> ğŸ¯ **åº”ç”¨åœºæ™¯**: é€‚åˆå¤„ç†ç»“æ„åŒ–æ•°æ®ï¼Œå¦‚æ¶ˆæ¯å¤´ã€æ¶ˆæ¯ä½“ç­‰

### 5. Gathering Writes èšé›†å†™å…¥ âœï¸

- èšé›†å†™å…¥æ˜¯æŒ‡å°†å¤šä¸ª buffer çš„æ•°æ®å†™å…¥ channel

```java
    try (RandomAccessFile file = new RandomAccessFile("helloword/3parts.txt", "rw")) {
    FileChannel channel = file.getChannel();
    ByteBuffer d = ByteBuffer.allocate(4);
    ByteBuffer e = ByteBuffer.allocate(4);
    channel.position(11);

    d.put(new byte[]{'f', 'o', 'u', 'r'});
    e.put(new byte[]{'f', 'i', 'v', 'e'});
    channel.write(new ByteBuffer[]{d, e});
    } catch (IOException e) {
        e.printStackTrace();
}
```


## ä¸‰ã€æ–‡ä»¶ç¼–ç¨‹ ğŸ“

### 1. FileChannel è¯¦è§£

#### (1). FileChannel çš„å·¥ä½œæ¨¡å¼ âš™ï¸

- FileChannel åªèƒ½å·¥ä½œåœ¨é˜»å¡æ¨¡å¼ä¸‹

#### (2). FileChannel çš„è·å– ğŸ”‘

ä¸èƒ½ç›´æ¥æ‰“å¼€ FileChannelï¼Œå¿…é¡»é€šè¿‡ FileInputStreamã€FileOutputStream æˆ–è€… RandomAccessFile æ¥è·å– FileChannelï¼Œå®ƒä»¬éƒ½æœ‰ getChannel æ–¹æ³•

- é€šè¿‡ FileInputStream è·å–çš„ channel åªèƒ½è¯»
- é€šè¿‡ FileOutputStream è·å–çš„ channel åªèƒ½å†™
- é€šè¿‡ RandomAccessFile æ˜¯å¦èƒ½è¯»å†™æ ¹æ®æ„é€  RandomAccessFile æ—¶çš„è¯»å†™æ¨¡å¼å†³å®š

#### (3). FileChannel çš„æ•°æ®è¯»å– ğŸ“¥

- ä¼šä» channel è¯»å–æ•°æ®å¡«å…… ByteBufferï¼Œè¿”å›å€¼è¡¨ç¤ºè¯»åˆ°äº†å¤šå°‘å­—èŠ‚ï¼Œ-1 è¡¨ç¤ºåˆ°è¾¾äº†æ–‡ä»¶çš„æœ«å°¾

```java
    int readBytes = channel.read(buffer);
```


#### (4). FileChannel çš„æ•°æ®å†™å…¥ âœï¸

- åœ¨ while ä¸­è°ƒç”¨ channel.write æ˜¯å› ä¸º write æ–¹æ³•å¹¶ä¸èƒ½ä¿è¯ä¸€æ¬¡å°† buffer ä¸­çš„å†…å®¹å…¨éƒ¨å†™å…¥ channel

```java
    while(buffer.hasRemaining()) {
        channel.write(buffer);
    }
```


#### (5). FileChannel çš„å…³é—­ ğŸšª

- channel å¿…é¡»å…³é—­ï¼Œä¸è¿‡è°ƒç”¨äº† FileInputStreamã€FileOutputStream æˆ–è€… RandomAccessFile çš„ close æ–¹æ³•ä¼šé—´æ¥åœ°è°ƒç”¨ channel çš„ close æ–¹æ³•

#### (6). FileChannel çš„æ•°æ®ä½ç½® ğŸ“

- è·å–å½“å‰ä½ç½®

```java
    long position = channel.position();
```


- è®¾ç½®å½“å‰ä½ç½®

```java
    channel.position(position);
```


- è·å–æ–‡ä»¶å¤§å°

```java
    long size = channel.size();
    channel.truncate(size); // æˆªæ–­æ–‡ä»¶
    channel.force(true);  // å¼ºåˆ¶å°†æ•°æ®å†™å…¥ç£ç›˜,å¦åˆ™æ•°æ®æ˜¯åœ¨ç¼“å­˜ä¸­ï¼Œä¸ä¼šå†™å…¥ç£ç›˜
 ```


### 2. ä¸¤ä¸ª Channel ä¼ è¾“æ•°æ® ğŸšš

```java
public class TestFileChannelTransferTo {
    public static void main(String[] args) {
        try (
                FileChannel from = new FileInputStream("data.txt").getChannel();
                FileChannel to = new FileOutputStream("to.txt").getChannel();
        ) {
            // æ•ˆç‡é«˜ï¼Œåº•å±‚ä¼šåˆ©ç”¨æ“ä½œç³»ç»Ÿçš„é›¶æ‹·è´è¿›è¡Œä¼˜åŒ–
            long size = from.size();
            // left å˜é‡ä»£è¡¨è¿˜å‰©ä½™å¤šå°‘å­—èŠ‚
            for (long left = size; left > 0; ) {
                System.out.println("position:" + (size - left) + " left:" + left);
                left -= from.transferTo((size - left), left, to);
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```


> âš¡ **é›¶æ‹·è´**: transferTo() æ–¹æ³•åˆ©ç”¨æ“ä½œç³»ç»Ÿçš„é›¶æ‹·è´æœºåˆ¶ï¼Œæ•ˆç‡æ›´é«˜

### 3. Path è·¯å¾„æ“ä½œ ğŸ›£ï¸

- Path ç”¨æ¥è¡¨ç¤ºæ–‡ä»¶è·¯å¾„
- Paths æ˜¯å·¥å…·ç±»ï¼Œç”¨æ¥è·å– Path å®ä¾‹

```java
    Path source = Paths.get("1.txt"); // ç›¸å¯¹è·¯å¾„ ä½¿ç”¨ user.dir ç¯å¢ƒå˜é‡æ¥å®šä½ 1.txt
    Path source = Paths.get("d:\\1.txt"); // ç»å¯¹è·¯å¾„ ä»£è¡¨äº†  d:\1.txt
    Path source = Paths.get("d:/1.txt"); // ç»å¯¹è·¯å¾„ åŒæ ·ä»£è¡¨äº†  d:\1.txt
    Path projects = Paths.get("d:\\data", "projects"); // ä»£è¡¨äº†  d:\data\projects
```


### 4. Files å·¥å…·ç±» ğŸ§°

- Files æ˜¯å·¥å…·ç±»ï¼Œç”¨æ¥æ“ä½œæ–‡ä»¶

#### (1). æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ ğŸ”

```java
    boolean exists = Files.exists(Paths.get("1.txt")); 
```


#### (2). åˆ›å»ºæ–‡ä»¶ ğŸ—ï¸

- åˆ›å»ºä¸€çº§ç›®å½•

```java
    Path path = Paths.get("helloword/d1");
    Files.createDirectory(path);
```


> âš ï¸ å¦‚æœç›®å½•å·²å­˜åœ¨ï¼Œä¼šæŠ›å¼‚å¸¸ FileAlreadyExistsException       
> âŒ ä¸èƒ½ä¸€æ¬¡åˆ›å»ºå¤šçº§ç›®å½•ï¼Œå¦åˆ™ä¼šæŠ›å¼‚å¸¸ NoSuchFileException

- åˆ›å»ºå¤šçº§ç›®å½•

```java
    Path path = Paths.get("helloword/d1/d2");
    Files.createDirectories(path);
```


#### (3). æ‹·è´æ–‡ä»¶ ğŸ“‹

```java
    Path source = Paths.get("helloword/data.txt");
    Path target = Paths.get("helloword/target.txt");
    
    Files.copy(source, target);
```


> âš ï¸ å¦‚æœç›®æ ‡æ–‡ä»¶å·²å­˜åœ¨ï¼Œä¼šæŠ›å¼‚å¸¸ FileAlreadyExistsException       
> ğŸ”„ å¦‚æœå¸Œæœ›ç”¨ source è¦†ç›–æ‰ targetï¼Œéœ€è¦ç”¨ StandardCopyOption æ¥æ§åˆ¶        
> `Files.copy(source, target, StandardCopyOption.REPLACE_EXISTING);`

#### (4). ç§»åŠ¨æ–‡ä»¶ ğŸšš

```java
    Path source = Paths.get("helloword/data.txt");
    Path target = Paths.get("helloword/data.txt");
    
    Files.move(source, target, StandardCopyOption.ATOMIC_MOVE);
```


> ğŸ”’ StandardCopyOption.ATOMIC_MOVE ä¿è¯æ–‡ä»¶ç§»åŠ¨çš„åŸå­æ€§

#### (5). åˆ é™¤æ–‡ä»¶ ğŸ—‘ï¸

```java
    Path target = Paths.get("helloword/target.txt");
    
    Files.delete(target);
```


> âš ï¸ å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¼šæŠ›å¼‚å¸¸ NoSuchFileException

#### (6). åˆ é™¤ç›®å½• ğŸ—‘ï¸

```java
    Path target = Paths.get("helloword/d1");
    
    Files.delete(target);
```


> âš ï¸ å¦‚æœç›®å½•è¿˜æœ‰å†…å®¹ï¼Œä¼šæŠ›å¼‚å¸¸ DirectoryNotEmptyException

#### (7). éå†ç›®å½• ğŸŒ³

```java
public static void main(String[] args) throws IOException {
    Path path = Paths.get("C:\\Program Files\\Java\\jdk1.8.0_91");
    AtomicInteger dirCount = new AtomicInteger();
    AtomicInteger fileCount = new AtomicInteger();
    Files.walkFileTree(path, new SimpleFileVisitor<Path>() {
        @Override
        public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) throws IOException {
          System.out.println(dir);
          dirCount.incrementAndGet();
          return super.preVisitDirectory(dir, attrs);
        }
    
        @Override
        public FileVisitResult visitFile(Path file, BasicFileAttributes attrs) throws IOException {
          System.out.println(file);
          fileCount.incrementAndGet();
          return super.visitFile(file, attrs);
        }
    
        @Override
        public FileVisitResult visitFileFailed(Path file, IOException exc) {
          return super.visitFileFailed(file, exc);
        }
    
        @Override
        public FileVisitResult postVisitDirectory(Path dir, IOException exc) {
          return super.postVisitDirectory(dir, exc);
        }
    });
    System.out.println(dirCount); // 133
    System.out.println(fileCount); // 1479
}
```


> ğŸ’¡ **SimpleFileVisitor**: æä¾›äº†æ–‡ä»¶éå†çš„é»˜è®¤å®ç°ï¼Œå¯ä»¥é‡å†™ç‰¹å®šæ–¹æ³•æ¥å¤„ç†ä¸åŒæƒ…å†µ