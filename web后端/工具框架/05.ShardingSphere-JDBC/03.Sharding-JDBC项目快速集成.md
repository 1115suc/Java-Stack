# ğŸš€ Sharding-JDBC é¡¹ç›®å¿«é€Ÿé›†æˆæŒ‡å—

## 1. ğŸ“¦ å¼•å…¥ä¾èµ–

```xml
<dependency>
  <groupId>org.apache.shardingsphere</groupId>
  <artifactId>sharding-jdbc-spring-boot-starter</artifactId>
</dependency>
```


> ğŸ’¡ **æç¤º**: Sharding-JDBC æ˜¯ Apache ShardingSphere çš„å­é¡¹ç›®ï¼Œæä¾›è½»é‡çº§ Java æ¡†æ¶ï¼Œç”¨äºåˆ†åº“åˆ†è¡¨åŠŸèƒ½ã€‚

## 2. âš™ï¸ é…ç½®é»˜è®¤æ•°æ®æº (ä¸ç”¨åˆ†åº“åˆ†è¡¨çš„æ•°æ®)

```properties
spring.shardingsphere.datasource.names=df
spring.shardingsphere.datasource.df.type=com.alibaba.druid.pool.DruidDataSource
spring.shardingsphere.datasource.df.driver-class-name=com.mysql.jdbc.Driver
spring.shardingsphere.datasource.df.url=jdbc:mysql://192.168.200.128:3306/stock_sys_db?useUnicode=true&characterEncoding=UTF-8&allowMultiQueries=true&useSSL=false&serverTimezone=Asia/Shanghai
spring.shardingsphere.datasource.df.username=root
spring.shardingsphere.datasource.df.password=24364726
# é…ç½®é»˜è®¤æ•°æ®æº
spring.shardingsphere.sharding.default-data-source-name=df
spring.shardingsphere.props.sql.show=true
```


> ğŸ› ï¸ **é‡è¦æé†’**: å¦‚æœå‡ºç°é…ç½® Bean è¦†ç›–é”™è¯¯ï¼Œåœ¨ä¸»é…ç½®æ–‡ä»¶ä¸­æ·»åŠ  `spring.main.allow-bean-definition-overriding=true`

## 3. ğŸ“¢ å¹¿æ’­è¡¨é…ç½® (æ‰€æœ‰èŠ‚ç‚¹éƒ½éœ€è¦é…ç½®)

å¹¿æ’­è¡¨æ˜¯æŒ‡åœ¨æ‰€æœ‰æ•°æ®æºä¸­éƒ½å­˜åœ¨çš„è¡¨ï¼Œæ•°æ®å®Œå…¨ä¸€è‡´ï¼Œå¸¸ç”¨äºå­—å…¸è¡¨ã€é…ç½®è¡¨ç­‰ã€‚

```properties
# ç¬¬ä¸€æ­¥ï¼šé…ç½®shardingjdbc
# æ•°æ®æºåç§°ï¼Œå¤šæ•°æ®æºä»¥é€—å·åˆ†éš”(datasourceåç§°ä¸è¦ä½¿ç”¨ç‰¹æ®Šç¬¦å·)
spring.shardingsphere.datasource.names=ds-2021,ds-2022,df

spring.shardingsphere.datasource.ds-2021.type=com.alibaba.druid.pool.DruidDataSource
spring.shardingsphere.datasource.ds-2021.driver-class-name=com.mysql.jdbc.Driver
spring.shardingsphere.datasource.ds-2021.url=jdbc:mysql://192.168.200.130:3306/stock_db_2021?useUnicode=true&characterEncoding=UTF-8&allowMultiQueries=true&useSSL=false&serverTimezone=Asia/Shanghai
spring.shardingsphere.datasource.ds-2021.username=root
spring.shardingsphere.datasource.ds-2021.password=root

spring.shardingsphere.datasource.ds-2022.type=com.alibaba.druid.pool.DruidDataSource
spring.shardingsphere.datasource.ds-2022.driver-class-name=com.mysql.jdbc.Driver
spring.shardingsphere.datasource.ds-2022.url=jdbc:mysql://192.168.200.131:3306/stock_db_2022?useUnicode=true&characterEncoding=UTF-8&allowMultiQueries=true&useSSL=false&serverTimezone=Asia/Shanghai
spring.shardingsphere.datasource.ds-2022.username=root
spring.shardingsphere.datasource.ds-2022.password=root

spring.shardingsphere.datasource.df.type=com.alibaba.druid.pool.DruidDataSource
spring.shardingsphere.datasource.df.driver-class-name=com.mysql.jdbc.Driver
spring.shardingsphere.datasource.df.url=jdbc:mysql://192.168.200.132:3306/stock_sys_db?useUnicode=true&characterEncoding=UTF-8&allowMultiQueries=true&useSSL=false&serverTimezone=Asia/Shanghai
spring.shardingsphere.datasource.df.username=root
spring.shardingsphere.datasource.df.password=root

# é…ç½®å¹¿æ’­è¡¨ï¼Œå¦‚æœæœ‰å¤šä¸ªï¼Œä»¥é€—å·é—´éš”
spring.shardingsphere.sharding.broadcast-tables=stock_business
spring.shardingsphere.sharding.default-data-source-name=df
spring.shardingsphere.props.sql.show=true
```


### ğŸ¯ å¹¿æ’­è¡¨ä½¿ç”¨åœºæ™¯
- é€‚ç”¨äºæ•°æ®é‡å°ä¸”éœ€è¦é¢‘ç¹å…³è”æŸ¥è¯¢çš„è¡¨
- é…ç½®è¡¨ã€å­—å…¸è¡¨ç­‰éœ€è¦åœ¨æ‰€æœ‰åˆ†ç‰‡ä¸­ä¿æŒä¸€è‡´çš„æ•°æ®

## 4. ğŸ—ï¸ åˆ†åº“å®ç°

### 4.1 åˆ†åº“ç­–ç•¥è¯´æ˜
åªåˆ†åº“ä¸åˆ†è¡¨ï¼šå¯å°†åˆ†åº“åˆ†è¡¨ç®—æ³•æŠ½å–å‡ºæ¥ä½œä¸ºå…¬å…±ç®—æ³•ç±»ï¼ŒåŒæ—¶åº“å†…æ²¡æœ‰åšåˆ†è¡¨å¤„ç†ï¼Œæ‰€ä»¥æ— éœ€å®šä¹‰åˆ†è¡¨ç­–ç•¥ã€‚

```java
// å…¬å…±åˆ†åº“ç®—æ³•
public class CommonShardingAlgorithm4Db implements PreciseShardingAlgorithm<Date>, RangeShardingAlgorithm<Date> {
    // ç²¾å‡†åŒ¹é…æ•°æ®åº“çš„æ–¹æ³• cur_time æ¡ä»¶å¿…é¡»æ˜¯ = æˆ–è€…in
    // åŒ¹é…åº“ ds-2021 ds-2022
    @Override
    public String doSharding(Collection<String> dsNames, PreciseShardingValue<Date> shardingValue) {
        //1.æ€è·¯ï¼šæ ¹æ®ä¼ å…¥çš„æ—¥æœŸå€¼ï¼Œè·å–å¹´ä»½å­—ç¬¦ä¸²
        //è·å–åˆ†ç‰‡å­—æ®µçš„åç§°colume
//        String columnName = shardingValue.getColumnName();
        //è·å–é€»è¾‘è¡¨åç§°
//        String logicTableName = shardingValue.getLogicTableName();
        //è·å–åˆ†ç‰‡å€¼
        Date value = shardingValue.getValue();
        //è·å–å¹´ä»½å­—ç¬¦ä¸²
        String year = new DateTime(value).getYear()+"";
        //2.è·å–æ•°æ®æºä¸­ä»¥
        Optional<String> optional = dsNames.stream().filter(ds -> ds.endsWith(year)).findFirst();
        String actual=null;
        //åˆ¤æ–­æ˜¯å¦æœ‰ç¬¦åˆæŒ‡å®šå¹´ä»½çš„æ•°æ®æº
        if (optional.isPresent()) {
            actual=optional.get();
        }
        return actual;
    }
    
    @Override
    public Collection<String> doSharding(Collection<String> dsNames, RangeShardingValue<Date> shardingValue) {
        //1.è·å–èŒƒå›´å°è£…å¯¹è±¡
        Range<Date> valueRange = shardingValue.getValueRange();
        //2.1 åˆ¤æ–­æ˜¯å¦æœ‰ä¸‹é™å€¼
        if (valueRange.hasLowerBound()) {
            //è·å–ä¸‹é™æ—¥æœŸ
            Date lowerDate = valueRange.lowerEndpoint();
            //è·å–å¹´ä»½  dsNames--> ds_2021 ds_2022 ds_2023
            int year = new DateTime(lowerDate).getYear();//2022
            dsNames= dsNames.stream().filter(dsName->Integer.valueOf(dsName.substring(dsName.lastIndexOf("-")+1))>=year)
                    .collect(Collectors.toList());
        }
        //2.2 åˆ¤æ–­æ˜¯å¦æœ‰ä¸Šé™å€¼
        if (valueRange.hasUpperBound()) {
            Date upperDate = valueRange.upperEndpoint();
            int year = new DateTime(upperDate).getYear();
            dsNames= dsNames.stream().filter(dsName->Integer.valueOf(dsName.substring(dsName.lastIndexOf("-")+1))<=year)
                    .collect(Collectors.toList());
        }

        return dsNames;
    }
}
```


### 4.2 åˆ†åº“é…ç½®æ–‡ä»¶

```properties
# ç¬¬äºŒæ­¥ï¼šé…ç½®æ¿å—è¡¨çš„æ•°æ®èŠ‚ç‚¹ä¿¡æ¯
spring.shardingsphere.sharding.tables.stock_block_rt_info.actual-data-nodes=ds-${2021..2022}.stock_block_rt_info
spring.shardingsphere.sharding.tables.stock_market_index_info.actual-data-nodes=ds-${2021..2022}.stock_market_index_info
spring.shardingsphere.sharding.tables.stock_outer_market_index_info.actual-data-nodes=ds-${2021..2022}.stock_outer_market_index_info

# æå–å…¬å…±æ•°æ®åº“åˆ†ç‰‡ç®—æ³•é…ç½®ç±»
common.algorithm4db=com.itheima.stock.sharding.CommonShardingAlgorithm4Db
common.algorithm4StockRtInfoTable=com.itheima.stock.sharding.ShardingAlgorithm4StockRtInfoTable

# ç¬¬ä¸‰æ­¥ï¼šé…ç½®æ•°æ®åº“çš„åˆ†ç‰‡ç®—æ³•
# åˆ†ç‰‡åˆ—åç§°
spring.shardingsphere.sharding.tables.stock_block_rt_info.database-strategy.standard.sharding-column=cur_time
# ç²¾ç¡®åˆ†ç‰‡ç®—æ³•ç±»åç§°ï¼Œç”¨äº = å’Œ INã€‚è¯¥ç±»éœ€å®ç° PreciseShardingAlgorithm æ¥å£å¹¶æä¾›æ— å‚æ•°çš„æ„é€ å™¨
spring.shardingsphere.sharding.tables.stock_block_rt_info.database-strategy.standard.precise-algorithm-class-name=${common.algorithm4db}
# èŒƒå›´åˆ†ç‰‡ç®—æ³•ç±»åç§°ï¼Œç”¨äº BETWEENï¼Œå¯é€‰ã€‚è¯¥ç±»éœ€å®ç° RangeShardingAlgorithm æ¥å£å¹¶æä¾›æ— å‚æ•°çš„æ„é€ å™¨
spring.shardingsphere.sharding.tables.stock_block_rt_info.database-strategy.standard.range-algorithm-class-name=${common.algorithm4db}

spring.shardingsphere.sharding.tables.stock_market_index_info.database-strategy.standard.sharding-column=cur_time
spring.shardingsphere.sharding.tables.stock_market_index_info.database-strategy.standard.precise-algorithm-class-name=${common.algorithm4db}
spring.shardingsphere.sharding.tables.stock_market_index_info.database-strategy.standard.range-algorithm-class-name=${common.algorithm4db}

spring.shardingsphere.sharding.tables.stock_outer_market_index_info.database-strategy.standard.sharding-column=cur_time
spring.shardingsphere.sharding.tables.stock_outer_market_index_info.database-strategy.standard.precise-algorithm-class-name=${common.algorithm4db}
spring.shardingsphere.sharding.tables.stock_outer_market_index_info.database-strategy.standard.range-algorithm-class-name=${common.algorithm4db}
```


### ğŸ“‹ åˆ†åº“ç­–ç•¥ç±»å‹è¯´æ˜
- **ç²¾ç¡®åˆ†ç‰‡ç®—æ³•**ï¼šç”¨äºå¤„ç† `=` å’Œ `IN` æŸ¥è¯¢
- **èŒƒå›´åˆ†ç‰‡ç®—æ³•**ï¼šç”¨äºå¤„ç† `BETWEEN` æŸ¥è¯¢

## 5. ğŸ—‚ï¸ åˆ†è¡¨å®ç°

åˆ†è¡¨æ˜¯åœ¨åˆ†åº“åŸºç¡€ä¸Šè¿›ä¸€æ­¥ç»†åˆ†æ•°æ®ï¼Œé€šå¸¸ç”¨äºå¤„ç†å•è¡¨æ•°æ®é‡è¿‡å¤§çš„æƒ…å†µã€‚

![1653413623345.png](img/1653413623345.png)

```java
// å…¬å…±åˆ†è¡¨ç®—æ³•
public class ShardingAlgorithm4StockRtInfoTable implements PreciseShardingAlgorithm<Date>, RangeShardingAlgorithm<Date> {
    @Override
    public String doSharding(Collection<String> tbNames, PreciseShardingValue<Date> shardingValue) {
        //1.æ€è·¯ï¼šæ ¹æ®ä¼ å…¥çš„æ—¥æœŸå€¼ï¼Œè·å–å¹´ä»½å­—ç¬¦ä¸²
        //è·å–åˆ†ç‰‡å­—æ®µçš„åç§°colume
//        String columnName = shardingValue.getColumnName();
        //è·å–é€»è¾‘è¡¨åç§°
//        String logicTableName = shardingValue.getLogicTableName();
        //è·å–åˆ†ç‰‡å€¼
        Date value = shardingValue.getValue();
        //è·å–å¹´æœˆç»„æˆçš„å­—ç¬¦ä¸²
        String yearMonth = new DateTime(value).toString(DateTimeFormat.forPattern("yyyyMM"));
        //è¿‡æ»¤è¡¨çš„åç§°é›†åˆï¼Œè·å–åç§°åç¼€ä¸yearMonthä¸€è‡´çš„è¡¨åç§°
        Optional<String> optional = tbNames.stream().filter(tbName -> tbName.endsWith(yearMonth)).findFirst();
        String tbName=null;
        if (optional.isPresent()) {
            tbName=optional.get();
        }
        return tbName;
    }

    @Override
    public Collection<String> doSharding(Collection<String> tbNames, RangeShardingValue<Date> shardingValue) {
        //1.è·å–èŒƒå›´å°è£…å¯¹è±¡
        Range<Date> valueRange = shardingValue.getValueRange();
        //2.1 åˆ¤æ–­æ˜¯å¦æœ‰ä¸‹é™å€¼
        if (valueRange.hasLowerBound()) {
            //è·å–ä¸‹é™æ—¥æœŸ
            Date lowerDate = valueRange.lowerEndpoint();
            //è·å–å¹´ä»½  dsNames--> ds_2021 ds_2022 ds_2023
            //è·å–å¹´æœˆç»„æˆçš„å­—ç¬¦ä¸²
            String yearMonth = new DateTime(lowerDate).toString(DateTimeFormat.forPattern("yyyyMM"));
            Integer yearM = Integer.valueOf(yearMonth);
            tbNames= tbNames.stream().filter(tbName->Integer.valueOf(tbName.substring(tbName.lastIndexOf("_")+1))>=yearM)
                    .collect(Collectors.toList());
        }
        //2.2 åˆ¤æ–­æ˜¯å¦æœ‰ä¸Šé™å€¼
        if (valueRange.hasUpperBound()) {
            Date upperDate = valueRange.upperEndpoint();
            String yearMonth = new DateTime(upperDate).toString(DateTimeFormat.forPattern("yyyyMM"));
            Integer yearM = Integer.valueOf(yearMonth);
            tbNames= tbNames.stream().filter(tbName->Integer.valueOf(tbName.substring(tbName.lastIndexOf("_")+1))<=yearM)
                    .collect(Collectors.toList());
        }
        return tbNames;
    }
}
```


### 5.1 åˆ†è¡¨é…ç½®æ–‡ä»¶

```properties
# é…ç½®è‚¡ç¥¨æµæ°´èŠ‚ç‚¹ä¿¡æ¯
spring.shardingsphere.sharding.tables.stock_rt_info.actual-data-nodes=ds-2021.stock_rt_info_${202101..202112},ds-2022.stock_rt_info_${202201..202212}
# æŠ½å–å…¬å…±é…ç½®ç±»å˜é‡
common.algorithm4StockRtInfoTable=com.itheima.stock.sharding.ShardingAlgorithm4StockRtInfoTable
# é…ç½®è‚¡ç¥¨æµæ°´åº“åˆ†ç‰‡ç­–ç•¥
spring.shardingsphere.sharding.tables.stock_rt_info.database-strategy.standard.sharding-column=cur_time
# ç²¾ç¡®åˆ†ç‰‡ç®—æ³•ç±»åç§°ï¼Œç”¨äº = å’Œ INã€‚è¯¥ç±»éœ€å®ç° PreciseShardingAlgorithm æ¥å£å¹¶æä¾›æ— å‚æ•°çš„æ„é€ å™¨
spring.shardingsphere.sharding.tables.stock_rt_info.database-strategy.standard.precise-algorithm-class-name=${common.algorithm4db}
# èŒƒå›´åˆ†ç‰‡ç®—æ³•ç±»åç§°ï¼Œç”¨äº BETWEENï¼Œå¯é€‰ã€‚è¯¥ç±»éœ€å®ç° RangeShardingAlgorithm æ¥å£å¹¶æä¾›æ— å‚æ•°çš„æ„é€ å™¨
spring.shardingsphere.sharding.tables.stock_rt_info.database-strategy.standard.range-algorithm-class-name=${common.algorithm4db}

# ç¬¬å››æ­¥ï¼šé…ç½®è¡¨çš„åˆ†ç‰‡ç®—æ³•
# å› ä¸ºstock_block_rt_infoæ¿å—è¡¨ä»…ä»…æŒ‰ç…§å¹´åˆ†åº“ï¼Œå¹¶æ²¡æœ‰åº“å†…åˆ†ç‰‡çš„æ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªåº“å†…çš„è¡¨åç§°éƒ½ä¸€æ ·ï¼Œä¸”åªæœ‰ä¸€ä¸ªï¼Œæ‰€ä»¥ä¸éœ€è¦å®šä¹‰åˆ†è¡¨çš„ç®—æ³•ç±»
# é…ç½®è‚¡ç¥¨æµæ°´è¡¨çš„åˆ†ç‰‡ç®—æ³•
spring.shardingsphere.sharding.tables.stock_rt_info.table-strategy.standard.sharding-column=cur_time
spring.shardingsphere.sharding.tables.stock_rt_info.table-strategy.standard.precise-algorithm-class-name=${common.algorithm4StockRtInfoTable}
spring.shardingsphere.sharding.tables.stock_rt_info.table-strategy.standard.range-algorithm-class-name=${common.algorithm4StockRtInfoTable}
```


### ğŸ“Š åˆ†åº“åˆ†è¡¨ç­–ç•¥æ€»ç»“
- **åˆ†åº“**ï¼šæŒ‰å¹´ä»½åˆ†åº“ï¼ˆå¦‚ ds-2021, ds-2022ï¼‰
- **åˆ†è¡¨**ï¼šæŒ‰å¹´æœˆåˆ†è¡¨ï¼ˆå¦‚ stock_rt_info_202101, stock_rt_info_202102ï¼‰

## ğŸ“ åŸºäº Sharding-JDBC å®è·µåˆ†åº“åˆ†è¡¨æ³¨æ„äº‹é¡¹

### 1. ğŸš« æŸ¥è¯¢ä¼˜åŒ–
- æ¡ä»¶æŸ¥è¯¢æ—¶åˆ†ç‰‡å­—æ®µä¸è¦ä½¿ç”¨å‡½æ•°å¤„ç†ï¼Œå¦åˆ™åˆ†ç‰‡ç®—æ³•å¤±æ•ˆï¼Œå¯¼è‡´å…¨èŠ‚ç‚¹æŸ¥è¯¢
    - ä¸¾ä¾‹ï¼š`select * from stock_rt_info where date_format(cur_time,'%Y%m%d')='20220910'`ï¼Œå‡½æ•°ä¼šé€ æˆ sharding çš„åˆ†ç‰‡å¤±æ•ˆï¼Œå¯¼è‡´å…¨èŠ‚ç‚¹æŸ¥è¯¢ï¼›
    - åŒæ—¶åœ¨ç´¢å¼•è§’åº¦çœ‹ï¼Œå¦‚æœæŸ¥è¯¢çš„åˆ†ç‰‡å­—æ®µä½¿ç”¨å‡½æ•°ï¼Œä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆï¼Œå¯¼è‡´æŸ¥è¯¢æ€§èƒ½è¾ƒä½ï¼›

### 2. ğŸ” æŸ¥è¯¢å…³é”®å­—ä¼˜åŒ–
- æ¡ä»¶æŸ¥è¯¢æ—¶å°½é‡ä½¿ç”¨ç¬¦åˆ sharding åˆ†ç‰‡æ¡ä»¶çš„å…³é”®å­—
    - ç²¾å‡†æŸ¥è¯¢å°½é‡ä½¿ç”¨ `IN`ã€`=`ï¼Œè€ŒèŒƒå›´æŸ¥è¯¢å°½é‡ä½¿ç”¨ `BETWEEN`ï¼›

### 3. ğŸ” åµŒå¥—æŸ¥è¯¢å¤„ç†
- Sharding-JDBC å¯¹åµŒå¥—æŸ¥è¯¢å¤„ç†ä¸å‹å¥½
    - å¦‚æœåµŒå¥—æŸ¥è¯¢çš„è¯ï¼Œé‚£ä¹ˆæœ€å¥½å­æŸ¥è¯¢çš„æ¡ä»¶åªå‘½ä¸­å•å¼ è¡¨ã€‚å¦‚æœå­æŸ¥è¯¢çš„æ¡ä»¶å…³è”äº†å¤šå¼ è¡¨ï¼Œé‚£ä¹ˆäº¤æ˜“åˆ†æ­¥éª¤æ‹†åˆ†å®ç°ï¼›
    - ç¤ºä¾‹ï¼šæˆ‘ä»¬é¡¹ç›®ä¸­çš„ K çº¿ç»Ÿè®¡ä¸­ï¼Œéœ€è¦å°† SQL æ‹†åˆ†ï¼Œç„¶ååˆ†æ­¥éª¤å®ç°ï¼›

### 4. ğŸ“Œ è¡¥å……è¯´æ˜
- **æ ‡å‡†åˆ†ç‰‡ç­–ç•¥**ï¼šé€‚ç”¨äºå•åˆ†ç‰‡é”®çš„åœºæ™¯ï¼Œæ”¯æŒç²¾ç¡®åŒ¹é…å’ŒèŒƒå›´åŒ¹é…
- **å¤åˆåˆ†ç‰‡ç­–ç•¥**ï¼šé€‚ç”¨äºå¤šåˆ†ç‰‡é”®çš„åœºæ™¯
- **Hint åˆ†ç‰‡ç­–ç•¥**ï¼šé€šè¿‡ Hint æŒ‡å®šåˆ†ç‰‡å€¼ï¼Œä¸ä¾èµ– SQL è§£æ
- **ä¸åˆ†ç‰‡ç­–ç•¥**ï¼šç”¨äºä¸éœ€è¦åˆ†ç‰‡çš„è¡¨