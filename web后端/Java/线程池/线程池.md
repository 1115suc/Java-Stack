# ğŸ§µ çº¿ç¨‹æ± è¯¦è§£

## ğŸ”§ çº¿ç¨‹æ± æ ¸å¿ƒå‚æ•°

çº¿ç¨‹æ± çš„å‡ ä¸ªæ ¸å¿ƒå‚æ•°ï¼š

- **æ ¸å¿ƒçº¿ç¨‹æ•°** (`corePoolSize`)
- æœ€å¤§çº¿ç¨‹æ•° (`maxPoolSize`)
- è¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æ•°çš„ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´å’Œæ—¶é—´å•ä½ (`keepAliveTime` + `TimeUnit`)
- ä»»åŠ¡é˜Ÿåˆ—é•¿åº¦ (`workQueue`)
- æ‹’ç»ç­–ç•¥ (`RejectedExecutionHandler`)
- çº¿ç¨‹å·¥å‚ (`ThreadFactory`)

## ğŸ”„ 1. çº¿ç¨‹æ± å·¥ä½œæµç¨‹æ¦‚è¿°

![image-20220107152235483.png](img/image-20220107152235483.png)

### å·¥ä½œæµç¨‹è¯´æ˜ï¼š

1. å½“ä¸€ä¸ªä»»åŠ¡é€šè¿‡ `submit` æˆ–è€… `execute` æ–¹æ³•æäº¤åˆ°çº¿ç¨‹æ± çš„æ—¶å€™ï¼Œå¦‚æœå½“å‰æ± ä¸­çº¿ç¨‹æ•°ï¼ˆåŒ…æ‹¬é—²ç½®çº¿ç¨‹ï¼‰å°äº `corePoolSize`ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹æ‰§è¡Œè¯¥ä»»åŠ¡
2. å¦‚æœå½“å‰çº¿ç¨‹æ± ä¸­çº¿ç¨‹æ•°å·²ç»è¾¾åˆ° `corePoolSize`ï¼Œåˆ™å°†ä»»åŠ¡æ”¾å…¥ç­‰å¾…é˜Ÿåˆ—
3. å¦‚æœä»»åŠ¡é˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™ä»»åŠ¡æ— æ³•å…¥é˜Ÿåˆ—ï¼Œæ­¤æ—¶å¦‚æœå½“å‰çº¿ç¨‹æ± ä¸­çº¿ç¨‹æ•°å°äº `maxPoolSize`ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªä¸´æ—¶çº¿ç¨‹ï¼ˆéæ ¸å¿ƒçº¿ç¨‹ï¼‰æ‰§è¡Œè¯¥ä»»åŠ¡
4. å¦‚æœå½“å‰æ± ä¸­çº¿ç¨‹æ•°å·²ç»ç­‰äº `maxPoolSize`ï¼Œæ­¤æ—¶æ— æ³•æ‰§è¡Œè¯¥ä»»åŠ¡ï¼Œå¯¹äºæ–°çš„ä»»åŠ¡ä¼šæ ¹æ®æ‹’ç»æ‰§è¡Œç­–ç•¥å¤„ç†

> âš ï¸ æ³¨æ„ï¼š
>
> å½“æ± ä¸­çº¿ç¨‹æ•°å¤§äº `corePoolSize`ï¼Œè¶…è¿‡ `keepAliveTime` æ—¶é—´çš„é—²ç½®çº¿ç¨‹ä¼šè¢«å›æ”¶æ‰ã€‚å›æ”¶çš„æ˜¯éæ ¸å¿ƒçº¿ç¨‹ï¼Œæ ¸å¿ƒçº¿ç¨‹ä¸€èˆ¬æ˜¯ä¸ä¼šå›æ”¶çš„ã€‚å¦‚æœè®¾ç½® `allowCoreThreadTimeOut(true)`ï¼Œåˆ™æ ¸å¿ƒçº¿ç¨‹åœ¨é—²ç½® `keepAliveTime` æ—¶é—´åä¹Ÿä¼šè¢«å›æ”¶ã€‚

## ğŸš« 2. çº¿ç¨‹æ± æ‹’ç»ç­–ç•¥

### 2.1 ä»€ä¹ˆæ—¶å€™ä¼šè§¦å‘æ‹’ç»ç­–ç•¥?

- å½“çº¿ç¨‹æ± è°ƒç”¨ `shutdown()` ç­‰æ–¹æ³•å…³é—­çº¿ç¨‹æ± åï¼Œå¦‚æœå†å‘çº¿ç¨‹æ± å†…æäº¤ä»»åŠ¡ï¼Œå°±ä¼šé­åˆ°æ‹’ç»
- **å½“çº¿ç¨‹è¾¾åˆ°æœ€å¤§çº¿ç¨‹æ•°ï¼Œä¸”æ— ç©ºé—²çº¿ç¨‹ï¼ŒåŒæ—¶ä»»åŠ¡é˜Ÿåˆ—å·²ç»æ»¡**

### 2.2 æ‹’ç»ç­–ç•¥ç±»å‹æœ‰å“ªäº›

JDKä¸ºæˆ‘ä»¬æä¾›äº†4ç§æ‹’ç»ç­–ç•¥ï¼š

#### ğŸš¨ `AbortPolicy`ï¼ˆæŠ›å‡ºå¼‚å¸¸ä¸­æ–­ç¨‹åºæ‰§è¡Œï¼‰ã€é»˜è®¤ã€‘

- è¿™ç§æ‹’ç»ç­–ç•¥åœ¨æ‹’ç»ä»»åŠ¡æ—¶ï¼Œä¼šç›´æ¥æŠ›å‡ºä¸€ä¸ªç±»å‹ä¸º `RejectedExecutionException` çš„ `RuntimeException`ï¼Œè®©ä½ æ„ŸçŸ¥åˆ°ä»»åŠ¡è¢«æ‹’ç»äº†ï¼Œäºæ˜¯ä½ ä¾¿å¯ä»¥æ ¹æ®ä¸šåŠ¡é€»è¾‘é€‰æ‹©é‡è¯•æˆ–è€…æ”¾å¼ƒæäº¤ç­‰ç­–ç•¥ã€‚
- è¯´ç™½äº†ä¸ä»…ä¸å¤„ç†å½“å‰ä»»åŠ¡ï¼Œå¹¶ä¸”è¿˜æŠ›å‡ºå¼‚å¸¸ï¼Œä¸­æ–­å½“å‰ä»»åŠ¡çš„æ‰§è¡Œã€‚

#### ğŸ—‘ï¸ `DiscardPolicy`ï¼ˆä»»åŠ¡ä¸¢å¼ƒä¸æŠ›å‡ºå¼‚å¸¸ï¼‰

- å½“æœ‰æ–°ä»»åŠ¡è¢«æäº¤åç›´æ¥è¢«ä¸¢å¼ƒæ‰ï¼Œä¹Ÿä¸ä¼šç»™ä½ ä»»ä½•çš„é€šçŸ¥ï¼Œç›¸å¯¹è€Œè¨€å­˜åœ¨ä¸€å®šçš„é£é™©ï¼Œå› ä¸ºæˆ‘ä»¬æäº¤çš„æ—¶å€™æ ¹æœ¬ä¸çŸ¥é“è¿™ä¸ªä»»åŠ¡ä¼šè¢«ä¸¢å¼ƒï¼Œå¯èƒ½é€ æˆæ•°æ®ä¸¢å¤±ã€‚

#### âª `DiscardOldestPolicy`ï¼ˆä¸¢å¼ƒå­˜æ´»æ—¶é•¿æœ€é•¿çš„ä»»åŠ¡ï¼‰

- ä¸¢å¼ƒä»»åŠ¡é˜Ÿåˆ—ä¸­çš„å¤´ç»“ç‚¹ï¼Œé€šå¸¸æ˜¯å­˜æ´»æ—¶é—´æœ€é•¿çš„ä»»åŠ¡ï¼Œå®ƒä¹Ÿå­˜åœ¨ä¸€å®šçš„æ•°æ®ä¸¢å¤±é£é™©ã€‚

#### ğŸ‘¤ `CallerRunsPolicy`ï¼ˆæ¨èï¼‰

- ç¬¬å››ç§æ‹’ç»ç­–ç•¥æ˜¯ï¼Œç›¸å¯¹è€Œè¨€å®ƒå°±æ¯”è¾ƒå®Œå–„äº†ï¼Œå½“æœ‰æ–°ä»»åŠ¡æäº¤åï¼Œå¦‚æœçº¿ç¨‹æ± æ²¡è¢«å…³é—­ä¸”æ²¡æœ‰èƒ½åŠ›æ‰§è¡Œï¼Œåˆ™æŠŠè¿™ä¸ªä»»åŠ¡äº¤äºæäº¤ä»»åŠ¡çš„çº¿ç¨‹æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è°æäº¤ä»»åŠ¡ï¼Œè°å°±è´Ÿè´£æ‰§è¡Œä»»åŠ¡ã€‚
- ä»»åŠ¡çº¿ç¨‹æ»¡äº†åï¼Œè¯¥ç­–ç•¥å¯å°†æ‰§è¡Œçš„äººä¸ºäº¤æ¢ç»™ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œè¿™ä¸ªè¿‡ç¨‹ç›¸å½“äºä¸€ä¸ªæ­£åé¦ˆï¼Œæ­¤æ—¶å¦‚æœä¸»çº¿ç¨‹èƒ½å¤„ç†ï¼Œåˆ™å¤„ç†ï¼Œå¦‚æœä¹Ÿä¸èƒ½å¤„ç†ï¼Œä¹Ÿå°±æ„å‘³ç€å½“å‰æœåŠ¡ä¸èƒ½æ¥æ”¶æ–°çš„ä»»åŠ¡äº†ã€‚
- ä¸»çº¿ç¨‹å¤„ç†ä»»åŠ¡æœŸé—´ï¼Œå¯ä»¥ä¸ºçº¿ç¨‹æ± è…¾å‡ºæ—¶é—´ï¼Œå¦‚æœæ­¤æ—¶æœ‰æ–°çš„ç©ºé—²çº¿ç¨‹ï¼Œé‚£ä¹ˆç»§ç»­ååŠ©ä¸»çº¿ç¨‹å¤„ç†ä»»åŠ¡ã€‚

### 2.3 å¦‚ä½•è‡ªå®šä¹‰æ‹’ç»ç­–ç•¥ï¼Ÿ

é€šè¿‡å®ç° `RejectedExecutionHandler` æ¥å£æ¥è‡ªå®šä¹‰ä»»åŠ¡æ‹’ç»ç­–ç•¥ã€‚

## ğŸ”¬ 3. éªŒè¯çº¿ç¨‹æ± å·¥ä½œæµç¨‹

### 3.1 ç¯å¢ƒå‡†å¤‡

ç‹¬ç«‹æ„å»ºä¸€ä¸ªSpring Bootæµ‹è¯•å·¥ç¨‹ï¼Œé…ç½®çº¿ç¨‹å‚æ•°ï¼š

```yaml
# å®šæ—¶ä»»åŠ¡çº¿ç¨‹æ± åŸºç¡€å‚æ•°
task:
  pool:
    corePoolSize: 5 # æ ¸å¿ƒçº¿ç¨‹æ•°
    maxPoolSize: 10 # è®¾ç½®æœ€å¤§çº¿ç¨‹æ•°
    keepAliveSeconds: 2 # è®¾ç½®çº¿ç¨‹æ´»è·ƒæ—¶é—´,å•ä½ç§’
    queueCapacity: 10 # è®¾ç½®é˜Ÿåˆ—å®¹é‡
```


#### å‚æ•°å°è£…ï¼š

```java
@ConfigurationProperties(prefix = "task.pool")
@Data
public class TaskThreadPoolInfo {
    /**
     *  æ ¸å¿ƒçº¿ç¨‹æ•°ï¼ˆè·å–ç¡¬ä»¶ï¼‰ï¼šçº¿ç¨‹æ± åˆ›å»ºæ—¶å€™åˆå§‹åŒ–çš„çº¿ç¨‹æ•°
     */
    private Integer corePoolSize;
    private Integer maxPoolSize;
    private Integer keepAliveSeconds;
    private Integer queueCapacity;
}
```


#### é…ç½®çº¿ç¨‹æ± ï¼š

```java
@Configuration
@EnableConfigurationProperties(TaskThreadPoolInfo.class)
@Slf4j
public class TaskExecutePool {
    private TaskThreadPoolInfo info;

    public TaskExecutePool(TaskThreadPoolInfo info) {
        this.info = info;
    }

    @Bean(name = "threadPoolTaskExecutor",destroyMethod = "shutdown")
    public ThreadPoolTaskExecutor threadPoolTaskExecutor(){
         //æ„å»ºçº¿ç¨‹æ± å¯¹è±¡
         ThreadPoolTaskExecutor taskExecutor = new ThreadPoolTaskExecutor();
         //æ ¸å¿ƒçº¿ç¨‹æ•°ï¼šæ ¸å¿ƒçº¿ç¨‹æ•°ï¼ˆè·å–ç¡¬ä»¶ï¼‰ï¼šçº¿ç¨‹æ± åˆ›å»ºæ—¶å€™åˆå§‹åŒ–çš„çº¿ç¨‹æ•°
         taskExecutor.setCorePoolSize(info.getCorePoolSize());
         //æœ€å¤§çº¿ç¨‹æ•°ï¼šåªæœ‰åœ¨ç¼“å†²é˜Ÿåˆ—æ»¡äº†ä¹‹åæ‰ä¼šç”³è¯·è¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æ•°çš„çº¿ç¨‹
         taskExecutor.setMaxPoolSize(info.getMaxPoolSize());
         //ç¼“å†²é˜Ÿåˆ—ï¼šç”¨æ¥ç¼“å†²æ‰§è¡Œä»»åŠ¡çš„é˜Ÿåˆ—
         taskExecutor.setQueueCapacity(info.getQueueCapacity());
         //å…è®¸çº¿ç¨‹çš„ç©ºé—²æ—¶é—´ï¼šå½“è¶…è¿‡äº†æ ¸å¿ƒçº¿ç¨‹å‡ºä¹‹å¤–çš„çº¿ç¨‹åœ¨ç©ºé—²æ—¶é—´åˆ°è¾¾ä¹‹åä¼šè¢«é”€æ¯
         taskExecutor.setKeepAliveSeconds(info.getKeepAliveSeconds());
         //çº¿ç¨‹åç§°å‰ç¼€
         taskExecutor.setThreadNamePrefix("StockThread-");
         //å‚æ•°åˆå§‹åŒ–
         taskExecutor.initialize();
         return taskExecutor;
    }
}
```


#### é…ç½®æ¨¡æ‹Ÿè‚¡ç¥¨é‡‡é›†æœåŠ¡ï¼š

```java
@Service
public class StockTimerService {
    /**
     * æ‹‰å–è‚¡ç¥¨æœåŠ¡
     */
    public void stockRtInto() {
        //æ¨¡æ‹Ÿç½‘ç»œI/O  1000æ¯«ç§’
        try {
            TimeUnit.MILLISECONDS.sleep(1000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}
```


### 3.2 ä»»åŠ¡é˜Ÿåˆ—æœªæ»¡å‰åœºæ™¯

#### 3.2.1 å¹¶å‘æƒ…å†µ-1

å¹¶å‘ä»»åŠ¡æ•°å°äºç­‰äºæ ¸å¿ƒçº¿ç¨‹æ•°æƒ…å†µï¼›

##### æµ‹è¯•ä»£ç ï¼š

å¾ªç¯æ€»ä»»åŠ¡æ•°ç­‰äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼š

```java
@SpringBootTest
@Slf4j
public class ThreadpooltestApplicationTests {
    @Autowired
    private StockTimerService stockTimerService;

    @Autowired
    private ThreadPoolTaskExecutor threadPoolTaskExecutor;

    @Test
    public  void contextLoads() throws InterruptedException {
        //çº¿ç¨‹æ± åˆå§‹åŒ–çº¿ç¨‹æ•°ä¸º0
        log.info("çº¿ç¨‹æ± åˆå§‹åŒ–å¤§å°:{}",threadPoolTaskExecutor.getPoolSize());
        for (int i = 0; i < 3; i++) {
               threadPoolTaskExecutor.execute(()->{
                   stockTimerService.stockRtInto();
               });
            //è·å–çº¿ç¨‹æ± å†…æœ€æ–°çš„çº¿ç¨‹æ•°é‡
            log.info("å½“å‰çº¿æ± å†…çš„ç¨‹æ•°ä¸ºï¼š{}",threadPoolTaskExecutor.getPoolSize());
        }
        //ä¼‘çœ 2sä¸­ï¼Œä¿è¯å‰3ä¸ªçº¿ç¨‹ä»»åŠ¡éƒ½æ‰§è¡Œå®Œï¼Œæœ‰é—²ä½™çš„çº¿ç¨‹
        TimeUnit.MILLISECONDS.sleep(2000);
        log.info("å½“å‰æ´»åŠ¨çº¿ç¨‹æ•°ï¼š{}" ,threadPoolTaskExecutor.getActiveCount());//æ­¤æ—¶ä¸º0ï¼Œè¯æ˜çº¿ç¨‹å†…æœ‰é—²ä½™çš„çº¿ç¨‹
        for (int i = 0; i < 2; i++) {
            threadPoolTaskExecutor.execute(()->{
                stockTimerService.stockRtInto();
            });
            //è·å–çº¿ç¨‹æ± å†…æœ€æ–°çš„çº¿ç¨‹æ•°é‡
            //å‘ç°åœ¨æ²¡æœ‰è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°æ—¶ï¼Œå“ªæ€•æœ‰æ–°çš„ä»»åŠ¡ï¼Œä¹Ÿä¾æ—§å¼€å¯æ–°çš„çº¿ç¨‹æ‰§è¡Œ
            log.info("å½“å‰çº¿æ± å†…çš„ç¨‹æ•°ä¸ºï¼š{}",threadPoolTaskExecutor.getPoolSize());
        }
        log.info("########ä»»åŠ¡çº¿ç¨‹æ„å»ºå®Œæ¯•");

        while (true) {
            int queueSize = threadPoolTaskExecutor.getThreadPoolExecutor().getQueue().size();
            log.info("å½“å‰é˜»å¡é˜Ÿåˆ—ä»»åŠ¡æ•°ï¼š{}" , queueSize);
            log.info("å½“å‰æ´»åŠ¨çº¿ç¨‹æ•°ï¼š{}" ,threadPoolTaskExecutor.getActiveCount());
            long completedTaskCount = threadPoolTaskExecutor.getThreadPoolExecutor().getCompletedTaskCount();
            log.info("çº¿ç¨‹æ± å®Œæˆä»»åŠ¡æ•°ï¼š{}" ,completedTaskCount);
            //å½“æ‰€æœ‰ä»»åŠ¡éƒ½å®Œæˆåï¼Œé‚£ä¹ˆcompletedTaskCount=taskCount
            long taskCount = threadPoolTaskExecutor.getThreadPoolExecutor().getTaskCount();
            log.info("æ€»çº¿æ± æ€»ä»»åŠ¡æ•°ï¼š{}" ,taskCount);
            try {
                Thread.sleep(500);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            //è·å–çº¿ç¨‹æ± å†…æœ€æ–°çš„çº¿ç¨‹æ•°é‡
            log.info("å½“å‰çº¿æ± å†…çš„ç¨‹æ•°ä¸ºï¼š{}",threadPoolTaskExecutor.getPoolSize());
            log.info("############################");
        }
    }
}
```


##### è¿è¡Œç»“æœè§£é‡Šï¼š

![0010.png](img/0010.png)

##### ç»“è®ºï¼š

- çº¿ç¨‹æ± å¯¹è±¡åˆå§‹åŒ–æ—¶é‡‡ç”¨å»¶è¿ŸåŠ è½½çš„æ–¹å¼æ„å»ºæ ¸å¿ƒçº¿ç¨‹å¯¹è±¡ï¼Œå› ä¸ºçº¿ç¨‹å¯¹è±¡æ„å»ºæœ‰èµ„æºå¼€é”€
- å½“çº¿ç¨‹æ± å†…çš„çº¿ç¨‹æ•°æœªè¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°æ—¶ï¼Œæ­¤æ—¶å“ªæ€•çº¿ç¨‹æ˜¯ç©ºé—²çš„ï¼Œä¸ä¼šå¤ç”¨çº¿ç¨‹ï¼Œè€Œæ˜¯æœ€å¤§åŠªåŠ›æ„å»ºæ–°çš„çº¿ç¨‹ï¼Œç›´åˆ°è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ä¸ºæ­¢

#### 3.2.2 å¹¶å‘æƒ…å†µ-2

å¹¶å‘ä»»åŠ¡æ•°å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œä¸”å°äºç­‰äºï¼ˆæ ¸å¿ƒçº¿ç¨‹æ•°+ä»»åŠ¡é˜Ÿåˆ—é•¿åº¦ï¼‰

æ­¤æ—¶å¾ªç¯ä»»åŠ¡æ•°ä¸ºï¼š15ï¼›

##### ç¤ºä¾‹ä»£ç ï¼š

```java
@SpringBootTest
@Slf4j
public class ThreadpooltestApplicationTests {
    @Autowired
    private StockTimerService stockTimerService;

    @Autowired
    private ThreadPoolTaskExecutor threadPoolTaskExecutor;

    @Test
    public  void contextLoads() throws InterruptedException {
        log.info("çº¿ç¨‹æ± åˆå§‹åŒ–å¤§å°:{}",threadPoolTaskExecutor.getPoolSize());
        for (int i = 0; i < 15; i++) {
            threadPoolTaskExecutor.execute(()->{
                stockTimerService.stockRtInto();
            });
            log.info("å½“å‰çº¿æ± å†…çš„ç¨‹æ•°ä¸ºï¼š{}",threadPoolTaskExecutor.getPoolSize());
        }
        log.info("########ä»»åŠ¡çº¿ç¨‹æ„å»ºå®Œæ¯•");

        while (true) {
            int queueSize = threadPoolTaskExecutor.getThreadPoolExecutor().getQueue().size();
            log.info("å½“å‰é˜»å¡é˜Ÿåˆ—ä»»åŠ¡æ•°ï¼š{}" , queueSize);
            log.info("å½“å‰æ´»åŠ¨çº¿ç¨‹æ•°ï¼š{}" ,threadPoolTaskExecutor.getActiveCount());
            long completedTaskCount = threadPoolTaskExecutor.getThreadPoolExecutor().getCompletedTaskCount();
            log.info("çº¿ç¨‹æ± å®Œæˆä»»åŠ¡æ•°ï¼š{}" ,completedTaskCount);
            long taskCount = threadPoolTaskExecutor.getThreadPoolExecutor().getTaskCount();
            log.info("æ€»çº¿æ± æ€»ä»»åŠ¡æ•°ï¼š{}" ,taskCount);
            try {
                Thread.sleep(800);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            log.info("å½“å‰çº¿æ± å†…çš„ç¨‹æ•°ä¸ºï¼š{}",threadPoolTaskExecutor.getPoolSize());
            log.info("############################");
        }
    }
}
```


##### æ•ˆæœï¼š

![çº¿ç¨‹æ± åœºæ™¯-2.png](img/2.png)

##### ç»“è®ºï¼š

- å½“æ ¸å¿ƒçº¿ç¨‹æ•°ä½¿ç”¨å®Œåï¼Œå¤šä½™çš„ä»»åŠ¡ä¼˜å…ˆå‹å…¥ä»»åŠ¡é˜Ÿåˆ—
- å½“æ ¸å¿ƒçº¿ç¨‹æ•°è¢«å ç”¨ï¼Œä¸”æœ‰æ–°çš„ä»»åŠ¡æ—¶ï¼Œä¼˜å…ˆå°†æ–°çš„ä»»åŠ¡å‹å…¥é˜Ÿåˆ—
- å½“æ ¸å¿ƒçº¿ç¨‹æ•°å·²æ»¡ï¼Œä¸”é˜»å¡é˜Ÿåˆ—å¦‚æœæœªå¡«æ»¡ï¼Œä¼šæŒç»­å¡«å…¥
- å½“æ ¸å¿ƒçº¿ç¨‹å­˜åœ¨ç©ºé—²æ—¶ï¼Œä¼šä¸»åŠ¨å»é˜»å¡é˜Ÿåˆ—ä¸‹é¢†å–æ–°çš„ä»»åŠ¡å¤„ç†

### 3.3 ä»»åŠ¡é˜Ÿåˆ—å·²æ»¡ååœºæ™¯

#### 3.3.1 å¹¶å‘æƒ…å†µ-3

é˜»å¡é˜Ÿåˆ—å·²æ»¡ï¼Œä¸”çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ä¸ºæœªè¾¾åˆ°æœ€å¤§çº¿ç¨‹æ•°ï¼š

æ­¤æ—¶å¾ªç¯ä»»åŠ¡æ•°ä¸ºï¼š20

```java
@SpringBootTest
@Slf4j
public class ThreadpooltestApplicationTests {
    @Autowired
    private StockTimerService stockTimerService;

    @Autowired
    private ThreadPoolTaskExecutor threadPoolTaskExecutor;

    @Test
    public  void contextLoads() throws InterruptedException {
        log.info("çº¿ç¨‹æ± åˆå§‹åŒ–å¤§å°:{}",threadPoolTaskExecutor.getPoolSize());
        for (int i = 0; i < 20; i++) {
            threadPoolTaskExecutor.execute(()->{
                stockTimerService.stockRtInto();
            });
            log.info("å½“å‰çº¿æ± å†…çš„ç¨‹æ•°ä¸ºï¼š{}",threadPoolTaskExecutor.getPoolSize());
        }
        log.info("########ä»»åŠ¡çº¿ç¨‹æ„å»ºå®Œæ¯•");

        while (true) {
            int queueSize = threadPoolTaskExecutor.getThreadPoolExecutor().getQueue().size();
            log.info("å½“å‰é˜»å¡é˜Ÿåˆ—ä»»åŠ¡æ•°ï¼š{}" , queueSize);
            log.info("å½“å‰æ´»åŠ¨çº¿ç¨‹æ•°ï¼š{}" ,threadPoolTaskExecutor.getActiveCount());
            long completedTaskCount = threadPoolTaskExecutor.getThreadPoolExecutor().getCompletedTaskCount();
            log.info("çº¿ç¨‹æ± å®Œæˆä»»åŠ¡æ•°ï¼š{}" ,completedTaskCount);
            long taskCount = threadPoolTaskExecutor.getThreadPoolExecutor().getTaskCount();
            log.info("æ€»çº¿æ± æ€»ä»»åŠ¡æ•°ï¼š{}" ,taskCount);
            try {
                Thread.sleep(800);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            log.info("å½“å‰çº¿æ± å†…çš„ç¨‹æ•°ä¸ºï¼š{}",threadPoolTaskExecutor.getPoolSize());
            log.info("############################");
        }
    }
}
```


##### æ•ˆæœï¼š

![3.png](img/3.png)

##### ç»“è®ºï¼š

- å½“æ ¸å¿ƒçº¿ç¨‹æ•°å·²è¢«ä½¿ç”¨ï¼Œä¸”ä»»åŠ¡é˜Ÿåˆ—å·²æ»¡ï¼Œä¼˜å…ˆå¼€å¯ä¸´æ—¶çº¿ç¨‹å¤„ç†ä»»åŠ¡
- çº¿ç¨‹æ‰§è¡Œæµç¨‹ï¼š1.å…ˆæ‰©å®¹5ä¸ªæ ¸å¿ƒçº¿ç¨‹å¤„ç†ä»»åŠ¡ 2.å°†å¤šä½™çš„10ä¸ªä»»åŠ¡å‹å…¥é˜Ÿåˆ— 3.å‰©ä¸‹çš„æ„å»ºä¸´æ—¶çº¿ç¨‹å¤„ç†ä»»åŠ¡ï¼ˆæœ€å¤§çº¿ç¨‹æ•°=ä¸´æ—¶çº¿ç¨‹æ•°+æ ¸å¿ƒçº¿ç¨‹æ•°ï¼‰
- ä¸´æ—¶çº¿ç¨‹å¦‚æœç©ºé—²ï¼Œä¸”è¾¾åˆ° `keepAliveSeconds` æŒ‡å®šçš„æœ€å¤§å­˜æ´»æ—¶é—´ï¼Œåˆ™ä¼šè¢«æ·˜æ±°ï¼Œç›´åˆ°è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ä¸ºæ­¢

#### 3.3.2 å¹¶å‘æƒ…å†µ-4

å¹¶å‘ä»»åŠ¡æ•°é‡è¶…è¿‡ï¼ˆæœ€å¤§çº¿ç¨‹æ•°+ä»»åŠ¡é˜Ÿåˆ—é•¿åº¦ï¼‰çš„æƒ…å†µï¼›

å®šä¹‰å¾ªç¯çº¿ç¨‹æ•°é‡ï¼š21ï¼Œè¶…è¿‡äº†1ä¸ªçº¿ç¨‹ï¼›

```java
@SpringBootTest
@Slf4j
public class ThreadpooltestApplicationTests {
    @Autowired
    private StockTimerService stockTimerService;

    @Autowired
    private ThreadPoolTaskExecutor threadPoolTaskExecutor;

    @Test
    public  void contextLoads() throws InterruptedException {
        log.info("çº¿ç¨‹æ± åˆå§‹åŒ–å¤§å°:{}",threadPoolTaskExecutor.getPoolSize());
        for (int i = 0; i < 21; i++) {
            threadPoolTaskExecutor.execute(()->{
                stockTimerService.stockRtInto();
            });
            log.info("å½“å‰çº¿æ± å†…çš„ç¨‹æ•°ä¸ºï¼š{}",threadPoolTaskExecutor.getPoolSize());
        }
        log.info("########ä»»åŠ¡çº¿ç¨‹æ„å»ºå®Œæ¯•");

        while (true) {
            int queueSize = threadPoolTaskExecutor.getThreadPoolExecutor().getQueue().size();
            log.info("å½“å‰é˜»å¡é˜Ÿåˆ—ä»»åŠ¡æ•°ï¼š{}" , queueSize);
            log.info("å½“å‰æ´»åŠ¨çº¿ç¨‹æ•°ï¼š{}" ,threadPoolTaskExecutor.getActiveCount());
            long completedTaskCount = threadPoolTaskExecutor.getThreadPoolExecutor().getCompletedTaskCount();
            log.info("çº¿ç¨‹æ± å®Œæˆä»»åŠ¡æ•°ï¼š{}" ,completedTaskCount);
            long taskCount = threadPoolTaskExecutor.getThreadPoolExecutor().getTaskCount();
            log.info("æ€»çº¿æ± æ€»ä»»åŠ¡æ•°ï¼š{}" ,taskCount);
            try {
                Thread.sleep(800);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            log.info("å½“å‰çº¿æ± å†…çš„ç¨‹æ•°ä¸ºï¼š{}",threadPoolTaskExecutor.getPoolSize());
            log.info("############################");
        }
    }
}
```


##### æ•ˆæœï¼š

![image-20220107173328287.png](img/image-20220107173328287.png)

é€šè¿‡é˜…è¯»æºç æˆ‘ä»¬å‘ç°ï¼š

![image-20220107173539283.png](img/image-20220107173539283.png)

é»˜è®¤é‡‡ç”¨ `AbortPolicy` ç­–ç•¥ï¼Œç›´æ¥ä¸­æ–­ç¨‹åºæ‰§è¡Œ

##### ç»“è®ºï¼š

- ä»€ä¹ˆæ—¶å€™è§¦å‘ä»»åŠ¡çš„æ‹’ç»ç­–ç•¥ï¼Ÿ
    - 1.ä»»åŠ¡é˜Ÿåˆ—å·²æ»¡ï¼Œä¸”æ²¡æœ‰ç©ºé—²çš„çº¿ç¨‹ï¼ˆçº¿ç¨‹å·²ç»è¾¾åˆ°æœ€å¤§çº¿ç¨‹æ•°ï¼‰ï¼Œåˆ™ä¼šè§¦å‘æ‹’ç»ç­–ç•¥
    - 2.çº¿ç¨‹æ± å¯¹è±¡ `shutdown` å…³é—­æ‹’ç»æœåŠ¡æ—¶ï¼Œä¹Ÿä¼šè§¦å‘æ‹’ç»ç­–ç•¥
    - 3.æ‹’ç»ç­–ç•¥ï¼š
        - JDKç»™æˆ‘ä»¬æä¾›äº†4ç§ï¼š
            - `AbortPolicy` æŠ›å‡ºå¼‚å¸¸ï¼Œç»ˆæ­¢ç¨‹åºå…è®¸
            - `DiscardPolicy` ä¸¢å¼ƒæ–°çš„ä»»åŠ¡ï¼Œä¸æŠ›å‡ºå¼‚å¸¸
            - `DiscardOldestPolicy` ä¸¢å¼ƒæ—§çš„ä»»åŠ¡ï¼Œä¸æŠ›å‡ºå¼‚å¸¸
            - `CallerRunsPolicy` å§”æ‰˜ä¸»çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ ä¸æŠ›å‡ºå¼‚å¸¸

## ğŸ¯ 4. è‡ªå®šä¹‰çº¿ç¨‹æ± æ‹’ç»ç­–ç•¥

### ç¬¬ä¸€æ­¥ï¼šè‡ªå®šä¹‰çº¿ç¨‹ä»»åŠ¡å¯¹è±¡

```java
public class StockTaskRunable implements Runnable{
    //æºå¸¦çš„ä»»åŠ¡ä¿¡æ¯,ä»»åŠ¡æ‹’ç»æ—¶ï¼Œä½¿ç”¨
    private Map<String,Object> infos;
    private StockTimerService stockTimerService;

    public StockTaskRunable(Map<String, Object> infos, StockTimerService stockTimerService) {
        this.infos = infos;
        this.stockTimerService = stockTimerService;
    }
    
    //ä»»åŠ¡é€»è¾‘
    @Override
    public void run() {
        stockTimerService.stockRtInto();
    }
    
    //æä¾›getæ–¹æ³•
    public Map<String, Object> getInfos() {
        return infos;
    }
}
```


### ç¬¬äºŒæ­¥ï¼šè‡ªå®šä¹‰æ‹’ç»ç­–ç•¥

```java
@Slf4j
public class StockTaskRejectedExecutionHandler implements RejectedExecutionHandler {
    @Override
    public void rejectedExecution(Runnable r, ThreadPoolExecutor executor) {
        if (r instanceof StockTaskRunable) {
            StockTaskRunable r2= ((StockTaskRunable) r);
            Map<String, Object> infos = r2.getInfos();
            log.info("å‡ºç°çš„å¼‚å¸¸çš„ä»»åŠ¡ä¿¡æ¯ï¼š{}",infos);
        }
    }
}
```


### ç¬¬ä¸‰æ­¥ï¼šé…ç½®æ‹’ç»ç­–ç•¥

```java
/**
 * å®šä¹‰ä»»åŠ¡æ‰§è¡Œå™¨
 * @return
 */
@Bean(name = "threadPoolTaskExecutor",destroyMethod = "shutdown")
public ThreadPoolTaskExecutor threadPoolTaskExecutor(){
     //æ„å»ºçº¿ç¨‹æ± å¯¹è±¡
     ThreadPoolTaskExecutor taskExecutor = new ThreadPoolTaskExecutor();
     //æ ¸å¿ƒçº¿ç¨‹æ•°ï¼šæ ¸å¿ƒçº¿ç¨‹æ•°ï¼ˆè·å–ç¡¬ä»¶ï¼‰ï¼šçº¿ç¨‹æ± åˆ›å»ºæ—¶å€™åˆå§‹åŒ–çš„çº¿ç¨‹æ•°
     taskExecutor.setCorePoolSize(info.getCorePoolSize());
     //æœ€å¤§çº¿ç¨‹æ•°ï¼šåªæœ‰åœ¨ç¼“å†²é˜Ÿåˆ—æ»¡äº†ä¹‹åæ‰ä¼šç”³è¯·è¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æ•°çš„çº¿ç¨‹
     taskExecutor.setMaxPoolSize(info.getMaxPoolSize());
     //ç¼“å†²é˜Ÿåˆ—ï¼šç”¨æ¥ç¼“å†²æ‰§è¡Œä»»åŠ¡çš„é˜Ÿåˆ—
     taskExecutor.setQueueCapacity(info.getQueueCapacity());
     //å…è®¸çº¿ç¨‹çš„ç©ºé—²æ—¶é—´ï¼šå½“è¶…è¿‡äº†æ ¸å¿ƒçº¿ç¨‹å‡ºä¹‹å¤–çš„çº¿ç¨‹åœ¨ç©ºé—²æ—¶é—´åˆ°è¾¾ä¹‹åä¼šè¢«é”€æ¯
     taskExecutor.setKeepAliveSeconds(info.getKeepAliveSeconds());
     //çº¿ç¨‹åç§°å‰ç¼€
     taskExecutor.setThreadNamePrefix("StockThread-");
     //è®¾ç½®æ‹’ç»ç­–ç•¥
      taskExecutor.setRejectedExecutionHandler(rejectedExecutionHandler());
     //å‚æ•°åˆå§‹åŒ–
     taskExecutor.initialize();
     return taskExecutor;
}

/**
 * è‡ªå®šä¹‰çº¿ç¨‹æ‹’ç»ç­–ç•¥
 * @return
 */
@Bean
public RejectedExecutionHandler rejectedExecutionHandler(){
    StockTaskRejectedExecutionHandler errorHandler = new StockTaskRejectedExecutionHandler();
    return errorHandler;
}
```


### ç¬¬å››æ­¥ï¼šæµ‹è¯•

```java
@Test
public  void contextLoads2() throws InterruptedException {
    log.info("çº¿ç¨‹æ± åˆå§‹åŒ–å¤§å°:{}",threadPoolTaskExecutor.getPoolSize());
     for (int i = 0; i < 21; i++) {
         HashMap<String, Object> info = new HashMap<>();
         info.put("handler","stockRtInfo");
         //è‡ªå®šä¹‰ä»»åŠ¡
         StockTaskRunable task = new StockTaskRunable(info, stockTimerService);
         threadPoolTaskExecutor.execute(task);
        log.info("å½“å‰çº¿æ± å†…çš„ç¨‹æ•°ä¸ºï¼š{}",threadPoolTaskExecutor.getPoolSize());
    }
    log.info("########ä»»åŠ¡çº¿ç¨‹æ„å»ºå®Œæ¯•");
    while (true) {
        int queueSize = threadPoolTaskExecutor.getThreadPoolExecutor().getQueue().size();
        log.info("å½“å‰é˜»å¡é˜Ÿåˆ—ä»»åŠ¡æ•°ï¼š{}" , queueSize);
        log.info("å½“å‰æ´»åŠ¨çº¿ç¨‹æ•°ï¼š{}" ,threadPoolTaskExecutor.getActiveCount());
        long completedTaskCount = threadPoolTaskExecutor.getThreadPoolExecutor().getCompletedTaskCount();
        log.info("çº¿ç¨‹æ± å®Œæˆä»»åŠ¡æ•°ï¼š{}" ,completedTaskCount);
        long taskCount = threadPoolTaskExecutor.getThreadPoolExecutor().getTaskCount();
        log.info("æ€»çº¿æ± æ€»ä»»åŠ¡æ•°ï¼š{}" ,taskCount);
        try {
            Thread.sleep(800);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        log.info("å½“å‰çº¿æ± å†…çš„ç¨‹æ•°ä¸ºï¼š{}",threadPoolTaskExecutor.getPoolSize());
        log.info("############################");
    }
}
```


##### æ•ˆæœï¼š

![image-20220107175842898](img/image-20220107175842898.png)

## ğŸ“Š 5. çº¿ç¨‹æ± å‚æ•°è®¾ç½®åŸåˆ™

### 5.1 å¦‚ä½•ä¸ºçº¿ç¨‹æ± è®¾ç½®åˆé€‚çš„çº¿ç¨‹å‚æ•°ï¼Ÿ

ç›®å‰æ ¹æ®ä¸€äº›å¼€æºæ¡†æ¶ï¼Œè®¾ç½®å¤šå°‘ä¸ªçº¿ç¨‹æ•°é‡é€šå¸¸æ˜¯æ ¹æ®åº”ç”¨çš„ç±»å‹ï¼š**I/O å¯†é›†å‹ã€CPU å¯†é›†å‹ã€‚**

#### ğŸŒ I/Oå¯†é›†å‹

I/Oå¯†é›†å‹çš„åœºæ™¯åœ¨å¼€å‘ä¸­æ¯”è¾ƒå¸¸è§ï¼Œæ¯”å¦‚åƒ MySQLæ•°æ®åº“è¯»å†™ã€æ–‡ä»¶çš„è¯»å†™ã€ç½‘ç»œé€šä¿¡ç­‰ä»»åŠ¡ï¼Œè¿™ç±»ä»»åŠ¡ä¸ä¼šç‰¹åˆ«æ¶ˆè€—CPUèµ„æºï¼Œä½†æ˜¯IOæ“ä½œæ¯”è¾ƒè€—æ—¶ï¼Œä¼šå ç”¨æ¯”è¾ƒå¤šæ—¶é—´ã€‚

- I/Oå¯†é›†å‹é€šå¸¸è®¾ç½®ä¸º `2n+1`ï¼Œå…¶ä¸­ `n` ä¸º CPU æ ¸æ•°
- è¯´ç™½äº†ï¼Œå¯¹äºI/Oå¯†é›†å‹çš„åœºæ™¯ï¼Œä¸å¤ªå ç”¨CPUèµ„æºï¼Œæ‰€ä»¥å¹¶å‘çš„ä»»åŠ¡æ•°å¤§äºCPUçš„æ ¸æ•°ï¼Œè¿™æ ·çš„è¯èƒ½æ›´åŠ å……åˆ†çš„åˆ©ç”¨CPUèµ„æº

#### ğŸ’» CPUå¯†é›†å‹

CPUå¯†é›†å‹çš„åœºæ™¯ï¼Œæ¯”å¦‚åƒåŠ è§£å¯†ï¼Œå‹ç¼©ã€è®¡ç®—ç­‰ä¸€ç³»åˆ—éœ€è¦å¤§é‡è€—è´¹ CPU èµ„æºçš„ä»»åŠ¡ï¼Œè¿™äº›åœºæ™¯å¤§éƒ¨åˆ†éƒ½æ˜¯çº¯CPUè®¡ç®—ã€‚

- CPUå¯†é›†å‹é€šå¸¸è®¾ç½®ä¸º `n+1`ï¼Œè¿™æ ·ä¹Ÿå¯é¿å…å¤šçº¿ç¨‹ç¯å¢ƒä¸‹CPUèµ„æºäº‰å¤ºå¸¦æ¥ä¸Šä¸‹æ–‡é¢‘ç¹åˆ‡æ¢çš„å¼€é”€

### 5.2 å¦‚ä½•è·å–å½“å‰æœåŠ¡å™¨çš„CPUæ ¸æ•°ï¼Ÿ

```java
int cores = Runtime.getRuntime().availableProcessors();
```


### 5.3 æ— ç•Œé˜Ÿåˆ—é—®é¢˜

å®é™…è¿è¡Œä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šè®¾ç½®çº¿ç¨‹æ± çš„é˜»å¡é˜Ÿåˆ—é•¿åº¦ï¼Œå¦‚æœä¸è®¾ç½®ï¼Œåˆ™é‡‡ç”¨é»˜è®¤å€¼ï¼š

```java
private int corePoolSize = 1;
private int maxPoolSize = Integer.MAX_VALUE;
private int keepAliveSeconds = 60;
private int queueCapacity = Integer.MAX_VALUE;
```


åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå¦‚æœè®¾ç½®æˆ–è€…ä½¿ç”¨ä¸å½“ï¼Œå®¹æ˜“é€ æˆå†…å­˜æº¢å‡ºé—®é¢˜ï¼ŒåŒæ—¶å¦‚æœè®¾ç½®äº†æ— ç•Œé˜Ÿåˆ—ï¼Œé‚£ä¹ˆçº¿ç¨‹æ± çš„æœ€å¤§çº¿ç¨‹æ•°ä¹Ÿå°±å¤±å»äº†æ„ä¹‰ã€‚

æ‰€ä»¥ä¼ä¸šå¼€å‘ä¸­ä¼šæ˜ä»¤**ç¦æ­¢ä½¿ç”¨é»˜è®¤çš„é˜Ÿåˆ—é•¿åº¦**ã€‚